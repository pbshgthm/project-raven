<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="d3.min.js"></script>
    <script src="support.js"></script>
    <script src="data.json"></script>
    <script src="s_data.json"></script>
    <script src="d3.layout.cloud.js"></script>
    <title>Raven Hybrid</title>
</head>

<body bgcolor="#ECEFF1">
    <div id="ground" style="position: absolute; top: 15vh; left:2vw;"></div>
</body>
<script type="text/javascript">
Data.init(raw_data);

var svg = d3.select("#ground")
    .append("svg")
    .attr("width", 900)
    .attr("height", 600)
    .style('background-color', 'white')
    .call(d3.zoom().on("zoom", function() {
        svg.attr("transform", d3.event.transform)
    }))
    .append("g")




function ageViolin() {
    var ageBins = Data.ageDist();
    var curveFunc = d3.line()
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] })
        .curve(d3.curveCardinal);

    function drawViolin(points) {
        var curve = svg.append("path")
            .attr("d", curveFunc(points))
            //.attr("stroke", '#FF7043')
            //.attr("stroke-width", 4)
            .attr("fill", "#FFAB91");
    }

    ageBins = [0].concat(ageBins).concat([0])
    agePoints = ageBins.map((x, i) => [450 - x / 10, 600 - (10 + 27 * i)])
    drawViolin(agePoints)
    agePoints = ageBins.map((x, i) => [450 + x / 10, 600 - (10 + 27 * i)])
    drawViolin(agePoints)

}

function ageBars() {

    var ageBins = Data.ageDist();
    var s1 = ageBins.reduce((sum, i) => sum + i, 0)

    function drawBars(points, clr = '#FFAB91') {
        var curve = svg.selectAll("bar")
            .data(points).enter()
            .append("rect")
            .attr("fill", clr)
            .attr("x", function(d, i) { return 50 + i * 40 })
            .attr("width", 35)
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("y", 400)
            .attr("height", 0)
            .attr('opacity', 0.5)
            .transition()
            .ease(d3.easeLinear)
            .duration(400)
            .delay(function(d, i) { return i * 30; })
            .attr("y", function(d, i) { return 400 - d / 7; })
            .attr("height", function(d, i) { return d / 7; });
    }

    drawBars(ageBins)
    var ageBins = [0, 0, 3, 0, 6, 27, 49, 98, 149, 365, 310, 546, 546, 385, 247, 196, 89, 12, 4, 1]
    var s2 = ageBins.reduce((sum, i) => sum + i, 0)
    //ageBins=ageBins.map(x=>x*(s1/s2))
    drawBars(ageBins, '#AED581')

}

//ageBars();
//ageViolin();

function timeLine() {

    var dates = Data.traffickDate();
    var colorise = d3.scaleSequential().domain([-50, 170])
        .interpolator(d3.interpolateInferno);

    function drawBars(points) {
        var bars = svg.selectAll("bar")
            .data(points).enter()
            .append("rect")
            .attr("fill", function(d) { return colorise(d) })
            .attr("x", function(d, i) { return i * 3.7 })
            .attr("width", 1)
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("y", 300)
            .attr("height", 0)
            .transition()
            .ease(d3.easeLinear)
            .duration(400)
            .delay(function(d, i) { return i * 30; })
            .attr("y", function(d, i) { return 300 - d; })
            .attr("height", function(d, i) { return d * 2; });
    }

    drawBars(dates)

}


function timeArcs() {
    var dates = Data.traffickDate();

    var curveFunc = d3.line()
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] })
        .curve(d3.curveBasis);

    var colorise = d3.scaleSequential().domain([0, 900])
        .interpolator(d3.interpolateInferno);

    function drawArc(src, dst, i) {

        var curve = svg.append("path")
            .attr("d", curveFunc([
                [50 + src, 300],
                [50 + (src + dst) / 2, 300 + 2 * (i - 0.5) * (dst - src) / 2],
                [50 + dst, 300]
            ]))
            .attr("stroke", colorise(dst - src))
            .attr("stroke-width", 2)
            .attr("opacity", 0.1)
            .attr("fill", "none");

        var totalLength = curve.node().getTotalLength();

        /*
        curve
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
            .duration(0)
            .ease(d3.easeLinear)
            .attr("stroke-dashoffset", 0)
        */

    }
    dates = dates.sort(function(a, b) { return a[0] - b[0] })
    var dura = []
    for (var i = 0; i < dates.length; i++) {
        var x = dates[i]
        dura.push(x[1] - x[0])
        //setTimeout(function(x,i){
        drawArc(x[0] * 3.5, x[1] * 3.5, i % 2);
        //},10,dates[i],i)
    }

    var a = Array(228).fill(0).map((d, i) => i)
    var dots = svg.selectAll('dots')
        .data(a).enter()
        .append('circle')
        .attr('cx', function(d) { return 50 + 3.5 * d })
        .attr('cy', 300)
        .attr('r', 1)
        .attr('fill', '#CFD8DC')

    /*
    var dura_list=Array(167).fill(0)
    dura.map(x=>dura_list[x]+=1)
    dura_list=dura_list.map((x,i)=>[50+i*20,550-x/5])
    dura_list=[[50,550]].concat(dura_list)
    var curveFunc = d3.line()
                          .x(function(d) {return d[0]})
                          .y(function(d) {return d[1]})
                          .curve(d3.curveBasis);
                          
      var curve = svg.append("path")
                        .attr("d", curveFunc(dura_list))
                        //.attr("stroke", 'red')
                        .attr("stroke-width", 2)
                        .attr("opacity",0.5)
                        .attr("fill", "#FFCCBC");
    */

}
//timeArcs();
//timeLine();

function raidPlot() {
    var r_data = Data.raidDist();
    var cir_data = []
    for (var i = 0; i < r_data.length; i++) {
        var x = 10 + i * 9;
        for (var j = 0; j < r_data[i].length; j++) {
            var y = j * 10;
            cir_data.push([x, y, r_data[i][j]])
        }
    }
    var dots = svg.selectAll('dots')
        .data(cir_data).enter()
        .append('circle')
        .attr('cx', function(d) { return d[0] })
        .attr('cy', function(d) { return 300 - d[1] })
        .attr('r', function(d) { return 1 + d[2] / 7 })
        .attr('fill', '#F4511E')
        .attr('opacity', 0.3)

    var r_line = r_data.map((x, i) => [10 + 9 * i, 315 + x.reduce((sum, i) => sum + i, 0)])
    var curveFunc = d3.line()
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] })
        .curve(d3.curveBasis);

    var curve = svg.append("path")
        .attr("d", curveFunc(r_line))
        //.attr("stroke", 'red')
        .attr("stroke-width", 2)
        .attr("opacity", 0.3)
        .attr("fill", "#FFCCBC");
    var a = Array(98).fill(0).map((d, i) => i)
    var dots = svg.selectAll('dots')
        .data(a).enter()
        .append('circle')
        .attr('cx', function(d) { return 10 + 9 * d })
        .attr('cy', 310)
        .attr('r', 2)
        .attr('fill', '#CFD8DC')
}
//raidPlot();

function amtPlot(split) {
    
    
    var a_clr=['#4FC3F7','#AED581','#FFB74D','#FF7043']

    var amt = Data.parPay();
    var a_type={'advance':0,'loan':1,'loan&advance':2}
    
    amt = amt.map(x=>[parseInt(x[0].split('-')[0]),
                      a_type[x[0].split('-')[1]],
                      x[1],
                      a_clr[a_type[x[0].split('-')[1]]]
                  ])

    amt.sort(function(a,b){return a[0]-b[0]})
    
    var a_dict={}
    for(var i=0;i<amt.length;i++){
        if(amt[i][0] in a_dict)
          a_dict[amt[i][0]]+=amt[i][2]
        else
          a_dict[amt[i][0]]=amt[i][2]
    }
    var amt_comb=[]
    for(var i=0;i<amt.length;i++){
        amt_comb.push([amt[i][0],1,a_dict[amt[i][0]],'#7E57C2'])
    }
    function plotAmtCir(data){

        var amtBub = svg.selectAll('circle')
            .data(data)

        var entering = amtBub.enter()
            .append("circle");

        amtBub.merge(entering)
            .transition().duration(500)
            .attr('cx', function(d) { return 100 * Math.log(d[0]) - 430 })
            .attr('cy', function(d) {return 300+(d[1]-1)*150})
            .attr('r', function(d) { return d[2] + 2 })
            .attr('fill', function(d){return d[3]})
            .attr('opacity', 0.3)
 
    }
    
    if(split=='comb')plotAmtCir(amt_comb)
    if(split=='split')plotAmtCir(amt)

}
//amtPlot('comb');

function indSplit(split) {

    var ind = Data.industryDist();
    var all_ind = [].concat(...ind)


    function packer(raw) {
        data = [{
            "name": "Root",
            "id": 0
        }];
        for (var i = 0; i < raw.length; i++)
            data.push({ 'size': raw[i], 'id': i + 1, 'parent': 0 })

        return data
    }

    var stratify = d3.stratify()
        .id(function(d) { return d.id; })
        .parentId(function(d) { return d.parent; });


    function getRoot(data) {
        return stratify(data)
            .sum(function(d) {
                return d.size;
            })
    }


    function packBub(root, b_w) {

        var pack = d3.pack()
            .size([b_w, b_w])
            .padding(2);

        var packedNodes = pack(root);
        var children = packedNodes.leaves();
        var circles = svg.selectAll('bubInd')
            .data(children);
        return circles['_enter'][0].map(x => [x['__data__']['x'],
            x['__data__']['y'],
            x['__data__']['r']
        ])

    }

    function plotIndBub(data) {

        var indBub = svg.selectAll('circle')
            .data(data)

        var entering = indBub.enter()
            .append("circle");

        indBub.merge(entering)
            .transition().duration(500)
            .attr('id', function(d, i) { return i })
            .attr('cx', function(d) { return d[0] })
            .attr('cy', function(d) { return d[1] })
            .attr('r', function(d) { return d[2] })
            .attr('fill', function(d) { return d[3] })
        //.attr('opacity',0.5)

    }

    var ofst = [
        [10, 100 + 40],
        [380, 210 + 40],
        [520, 215 + 40],
        [650, 155 + 40]
    ];
    var bubClr = ['#B2EBF2', '#E1BEE7', '#C8E6C9', '#FFCCBC'];
    var comb_ofst = [
        [170, 210 + 90],
        [430, 210 + 90],
        [565, 210 + 90],
        [765, 210 + 90]
    ];
    var splitBub = [];
    var combBub = [];

    for (var i = 0; i < ind.length; i++) {
        var data = packer(ind[i])
        var cir_data = packBub(getRoot(data), ind[i].reduce((x, i) => x + i, 0) / 17);
        cir_data = cir_data.map(x => [x[0] + ofst[i][0], x[1] + ofst[i][1], x[2], bubClr[i]])
        splitBub = splitBub.concat(cir_data);


        var comb_r = ind[i].reduce((x, i) => x + i, 0) / 40
        var comb_cir_data = Array(ind[i].length).fill([comb_ofst[i][0],
            comb_ofst[i][1],
            comb_r,
            bubClr[i]
        ])
        combBub = combBub.concat(comb_cir_data)
    }



    var lineBub = [];
    var k = 0;
    for (var i = 0; i < ind.length; i++) {
        var x = 150 + 200 * i;
        var y = 0;
        for (var j = 0; j < ind[i].length; j++) {
            var lb = splitBub[k].slice();
            lb[0] = x;
            var c = y + lb[2] + 10;
            y += 2 * lb[2]
            lb[1] = c
            lineBub.push(lb)
            k += 1;
        }
    }

    if (split == 'comb') plotIndBub(combBub)
    if (split == 'split') plotIndBub(splitBub)
    if (split == 'line') plotIndBub(lineBub)

};
//indSplit('split');


function plotPie() {
    var data = Data.getDict('brought');
    data.shift();
    data = data.map(x => x[1] / data.reduce((sum, x) => sum + x[1], 0));
    data.sort(function(a, b) { return b - a });

    function drawArc(from, length, clr) {

        var arc = d3.arc()
            .innerRadius(180)
            .outerRadius(200)
            .startAngle((from + 0.5) * (Math.PI / 180))
            .endAngle((from + length - 0.5) * (Math.PI / 180))


        svg.append("path")
            .attr("d", arc)
            .attr("fill", clr)
            .attr('opacity', 0.8)
            .attr("transform", "translate(450,300)");
    }

    var prev_ang = 0;
    var arcClrs = ['#AB47BC', '#9CCC65', '#EC407A', '#FF7043', '#42A5F5', '#FFCA28', '#EC407A', '#26C6DA']
    for (var i = 0; i < data.length; i++) {
        var ang = data[i] * 360;
        drawArc(prev_ang, ang, arcClrs[i])
        prev_ang += ang;
    }
}
//plotPie();


function plotBars() {
    var data = Data.getDict('paypar');
    data.shift();
    data = data.map(x => x[1] / data.reduce((sum, x) => sum + x[1], 0));
    data.sort(function(a, b) { return b - a });




    var arcClrs = ['#AB47BC', '#9CCC65', '#EC407A', '#FF7043', '#42A5F5', '#FFCA28', '#EC407A', '#26C6DA']

    function drawBars(points) {
        var curve = svg.selectAll("bar")
            .data(points).enter()
            .append("rect")
            .attr("fill", function(d, i) { return arcClrs[i] })
            .attr("x", function(d, i) { return 250 + i * 80 })
            .attr("width", 20)
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("y", 550)
            .attr("height", 0)
            .attr('opacity', 0.7)
            .transition()
            .ease(d3.easeLinear)
            .duration(400)
            .delay(function(d, i) { return i * 30; })
            .attr("y", function(d) { return 550 - d * 1500; })
            .attr("height", function(d) { return d * 1500; });
    }
    drawBars(data);

}
//plotBars();

function plotSib() {
    var sibData = sib;

    sibData.shift();
    var sibMat = Array(5).fill(0)
    sibMat = sibMat.map(x => Array(5).fill(0))

    for (var i = 0; i < sibData.length; i++) {
        var b = sibData[i][0].split('-')[0]
        var s = sibData[i][0].split('-')[1]
        if (b == "" || s == "") continue;
        if (b > 3) b = 4
        if (s > 3) s = 4
        sibMat[b][s] += sibData[i][1]
    }


    var sibVal = []
    for (var i = 0; i < 5; i++) {
        for (var j = 0; j < 5; j++) {
            //sibVal.push([360+i*90,-270+j*90,sibMat[i][j]/9])
            sibVal.push([270 + i * 90, 150 + j * 90, sibMat[i][j] / 9])
        }
    }

    var colorise = d3.scaleSequential().domain([0, 50])
        .interpolator(d3.interpolateInferno);


    var line = d3.line()
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] });

    for (var i = 0; i < 5; i++) {
        for (var j = 0; j < i; j++) {
            var path = svg.append('g')
                //.attr('transform','rotate(45)')
                .append('path')
                .attr('d', line([
                        //[360-0.3*90,-270+i*90+4*(j-i/2+0.5)],
                        //[360+4*90,-270+i*90+4*(j-i/2+0.5)]]
                        [270 - 0.3 * 90, 150 + i * 90 + 6 * (j - i / 2 + 0.5)],
                        [270 + 4 * 90, 150 + i * 90 + 6 * (j - i / 2 + 0.5)]
                    ]

                ))
                .attr("stroke", '#F06292')
                .attr("stroke-width", 3)
                .attr('opacity', 0.2)

            var path = svg.append('g')
                //.attr('transform','rotate(45)')
                .append('path')
                .attr('d', line([
                        //[360+i*90+4*(j-i/2+0.5),-270-0.3*90],
                        //[360+i*90+4*(j-i/2+0.5),-270+4*90]]
                        [270 + i * 90 + 6 * (j - i / 2 + 0.5), 150 - 0.3 * 90],
                        [270 + i * 90 + 6 * (j - i / 2 + 0.5), 150 + 4 * 90]
                    ]

                ))
                .attr("stroke", '#64B5F6')
                .attr("stroke-width", 3)
                .attr('opacity', 0.2)
        }
    }

    var sibGrp = svg.append('g')
    //.attr('transform','rotate(45)')
    var sibCir = sibGrp.selectAll('sibCir')
        .data(sibVal).enter()
        .append('circle')
        .attr('id', function(d, i) { return i })
        .attr('cx', function(d) { return d[0] })
        .attr('cy', function(d) { return d[1] })
        .attr('r', function(d) { return d[2] + 3 })
        .attr('fill', function(d) { return colorise(d[2]) })
        .attr('opacity', 1)
        .attr("stroke", 'white')
        .attr("stroke-width", 6)


}
//plotSib();

function plotWage(state='init') {
    var wage = wageData;
    var wageSplit = [];
    var wageComb = [];
    var wageInit = [];
    var wageCount = 0;
    var w_clr = ['#B0BEC5', '#2196F3', '#8BC34A', '#FFA726', '#AB47BC']

    for (var i = 0; i < wage.length; i++) {
        var w = wage[i][0].split('-')
        wageSplit.push([-300 + 140 * Math.log(1 + parseInt(w[0])),
            300 + 70 * (parseInt(w[1]) - 2.5),
            wage[i][1] / 10,
            w_clr[parseInt(w[1])]
        ])

        wageComb.push([-300 + 140 * Math.log(1 + parseInt(w[0])),
            300,
            wage[i][1] / 10,
            '#5C6BC0'
        ])
        wageCount += wage[i][1] / 10;
    }

    wageInit.push([250, 300, 5 * Math.sqrt(wageSplit[0][2]), '#B0BEC5']);
    var wInit = Array(wageComb.length - 1).fill([600, 300,
        5 * Math.sqrt(wageCount - wageSplit[0][2]), '#5C6BC0'
    ])
    wageInit = wageInit.concat(wInit)

    wageComb[0][2] = wageSplit[0][2] = 5 * Math.sqrt(wageSplit[0][2]);
    wageComb[0][3] = wageSplit[0][3] = "#B0BEC5";

    function plotWageBub(data) {
        var wageBub = svg.selectAll('circle')
            .data(data)

        var entering = wageBub.enter()
            .append("circle");

        wageBub.merge(entering)
            .transition().duration(500)
            .attr('fill', function(d) { return d[3] })
            .transition().delay(300).duration(500)
            .attr('cx', function(d) { return d[0] })
            .attr('cy', function(d) { return d[1] })
            .attr('r', function(d) { return 2 + d[2] })
            .attr('opacity', 0.5)

    }
    if (state == 'comb')
        plotWageBub(wageComb);
    if (state == 'split')
        plotWageBub(wageSplit);
    if (state == 'init')
        plotWageBub(wageInit);

}
//plotWage();

function plotInc(){
    
    
    
    /*
    var inc=famInc;
    inc=inc.sort(function(a,b){return a[0]-b[0]});
    inc=inc.map(x=>[5+x[0]/100,440-x[1]*2])
    inc=[[12,450]].concat(inc)
    inc.push([2010,450])
    var curveFunc = d3.line()
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] })
        .curve(d3.curveMonotoneX);

    var curve = svg.append("path")
            .attr("d", curveFunc(inc))
            //.attr("stroke", '#FF7043')
            .attr("stroke-width", 4)
            .attr("fill", "#FFAB91")
            .attr('opacity',1)


    var inc=famInc;
    inc=inc.sort(function(a,b){return a[0]-b[0]});
    var line = d3.line()
               .x(function(d) { return d[0] })
               .y(function(d) { return d[1] });

    for(var i=0;i<inc.length;i++){

      var path = svg
                  .append('path')
                  .attr('d', line([
                                [5+inc[i][0]/100,450],
                                [5+inc[i][0]/100,440-inc[i][1]*2]
                  ]))
                  .attr("stroke", 'white')
                  .attr("stroke-width", 2)
                  .attr('opacity',0.5)
    }
    */
    var inc=famInc;
    inc=inc.sort(function(a,b){return a[0]-b[0]});
    inc=inc.map(x=>[15+x[0]/100,x[1]/2])

    var incBub = svg.selectAll('circle')
            .data(inc)

        var entering = incBub.enter()
            .append("circle");

        incBub.merge(entering)
            .transition().duration(500)
            .attr('fill', '#F4511E')
            .attr('cx', function(d) { return d[0] })
            .attr('cy', 300)
            .attr('r', function(d) { return 2 + d[1] })
            .attr('opacity', 0.1)

}
//plotInc();

</script>

</html>