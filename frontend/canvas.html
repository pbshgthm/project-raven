<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="d3.min.js"></script>
  <script src="support.js"></script>
  <script src="data.json"></script>
  <title>Raven Canvas</title>
	
</head>
<body>
	<div id="ground"></div>
</body>
<script type="text/javascript">


var width=1000;
var height=800;

var canvas = d3.select('#ground').append('canvas').attr('width', width).attr('height', height);
var context = canvas.node().getContext('2d');



var svg;
var circles;
var d_num=12500;

var clrs=['#e53935','#D81B60','#8E24AA','#5E35B1','#3949AB','#1E88E5','#039BE5','#00ACC1','#00897B','#43A047','#7CB342','#C0CA33','#F9A825','#FF8F00','#FB8C00','#F4511E','#6D4C41','#757575','#546E7A']

Data.init(raw_data);

var curr_state;

var data=[]
for(var i=0;i<d_num;i++)
  data.push([120+((i%100)*5),110+Math.floor(i/100)*5,2])
curr_state=data



function updateDots(data,duration=1500) {

  
  var ease = d3.easeCubic;

  var point_src=curr_state;

  var timer = d3.timer((elapsed) => {
    
        var t = Math.min(1, ease(elapsed / duration));
        var point_inter=[]
        for(var i=0;i<data.length;i++){

              try{
                    point_inter.push([
                      point_src[i][0]*(1-t)+data[i][0]*t,
                      point_src[i][1]*(1-t)+data[i][1]*t,
                      point_src[i][2]*(1-t)+data[i][2]*t,
                    ])
              }
              catch{
                    console.log(data[i],i,point_src.length,t)
              }
              

        }
          

        context.clearRect(0, 0, width, height);

        point_inter.forEach(function(d, i) {
            context.beginPath();
            context.arc(d[0]+0.5, d[1]+0.5, d[2] , 0, 2 * Math.PI, false);
            context.fillStyle="red";
            context.fill();
            context.closePath();
        });
        
        if (t === 1)timer.stop();

  });
  curr_state=data;
}


function shuffle(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }return array;
}


function plotBars(data,layout,sym=false,shuf=true){


  
  
  var dot_size=layout['dot_size'];
  var base_y=layout['base_y'];
  var start_x=layout['start_x'];
  var width_n=layout['width_n'];
  var dot_pad=layout['dot_pad'];
  var bar_pad=layout['bar_pad'];

  var bins=[]
  var pad=dot_pad+dot_size*2;
  for(var i=0;i<data.length;i++){
    s_x=start_x+(bar_pad+width_n*pad)*i;

    for(var j=0;j<data[i];j++){
      var sym_ofst=0
      if(sym)sym_ofst=Math.round(data[i]/width_n)*pad/2;
      
      bins.push([s_x+pad*(j%width_n),(base_y+sym_ofst)-Math.floor(j/width_n)*pad,dot_size])
    }
  }

  bins=bins.concat(Array(d_num-bins.length).fill([10,10,2]));
  if(shuf)return shuffle(bins)
  else return bins 
}





function goPack(){
  data=[]
  for(var i=0;i<d_num;i++)
    data.push([220+((i%100)*5),300+Math.floor(i/100)*5,1.5])
  data=data.concat(Array(5).fill(data[0]))
  updateDots(shuffle(data));
}

function goDate(){
  var tlLayout={
      dot_size:1.2,
      base_y:400,
      start_x:50,
      width_n:1,
      dot_pad:2.5,
      bar_pad:3
  }
  updateDots(plotBars(Data.traffickDate(),tlLayout,sym=true));
}


function goAge(){

  var ageLayout={
      dot_size:0.75,
      base_y:550,
      start_x:20,
      width_n:15,
      dot_pad:1.5,
      bar_pad:3
  }
  updateDots(plotBars(Data.ageDist(),ageLayout));
  
}

function goInd(exp=true){

  var dot_size=1.2;
  var base_y=750;
  var start_x=100;
  var width_n=40;
  var dot_pad=1.5;
  var bar_pad=30;

  var indLayout={
      dot_size:1.2,
      base_y:750,
      start_x:100,
      width_n:40,
      dot_pad:1.5,
      bar_pad:30
  }
    
  var ind=Data.industryDist()
  

  var bins=[]
  var pad=dot_pad+dot_size*2;
  for(var i=0;i<ind.length;i++){
    s_x=start_x+(bar_pad+width_n*pad)*i;
    var prev_xof=0;
    for(var k=0;k<ind[i].length;k++){
        cat_ofst=k*(exp?-20:0);
        for(var j=prev_xof;j<ind[i][k]+prev_xof;j++){
            bins.push([s_x+pad*(j%width_n),(base_y+cat_ofst)-Math.floor(j/width_n)*pad,dot_size])
        }
        prev_xof+=ind[i][k];
    }
    
  }

  bins=bins.concat(Array(d_num-bins.length).fill([10,10,2]));
  
  updateDots(bins)
  
}
	




updateDots(curr_state,1);

///////////////////////////////////






function packCircle(num,size,center,space) {

      var radius=space*Math.sqrt(num)
      var data=Array(num).fill(size)

      console.log(radius)

      function packer(raw){
          data=[{
              "name": "Root",
              "id": 0
          }];
          for(var i=0;i<raw.length;i++)
          data.push({'size':raw[i],'id':i+1,'parent':0})

          return data
      }

      var stratify = d3.stratify()
          .id(function(d) { return d.id; })
          .parentId(function(d) { return d.parent; });

      var pack = d3.pack()
          .size([radius*2, radius*2]);



      function getRoot(data) {
          return stratify(data)
              .sum(function(d) {
                      return d.size;
              })
              .sort( function(a, b) {
              return 0;
          });
      }


      var packedNodes = pack(getRoot(packer(data)));
      var children = packedNodes.leaves();
      var data = children.map(x=>[
        x['x']+center[0]-radius,
        x['y']+center[1]-radius,
      1])

      return shuffle(data)

};

// for industry function

function drawind(){
  var ind=Data.industryDist();

  var cat=ind.map(x=>x.reduce((sum,i)=>sum+i,0))
  

  var cir1=packCircle(cat[0],1,[160,400],2);
  cir1=cir1.concat(packCircle(cat[1],1,[400,400],2));
  cir1=cir1.concat(packCircle(cat[2],1,[580,400],2));
  cir1=cir1.concat(packCircle(cat[3],1,[800,400],2));

  cir1 = shuffle(cir1).concat(Array(12500-cir1.length).fill([1,2,3]))
  updateDots(cir1);

}





</script>
</html>