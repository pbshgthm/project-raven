<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
    <script src="js/d3.min.js"></script>
    <script src="js/d3.geo.min.js"></script>
    <script src="js/indiaGeo.json"></script>
    <script src="js/support.js"></script>
    <script src="js/u_data.json"></script>
    <script src="js/d3-chromatic.min.js"></script>
    <link rel="stylesheet" type="text/css" href="assets/main.css">
    <title>Project Raven</title>
</head>

<body>
    <div id="nav-pane">
        <div id="nav-list">
            <div class="nav-btn" id="nav-map">Map</div>
            <div class="nav-btn" id="nav-state">State stats</div>
            <div class="nav-btn" id="nav-age">Age</div>
            <div class="nav-btn" id="nav-traf">Taffick Date</div>
            <div class="nav-btn" id="nav-raid">Raid date</div>
            <div class="nav-btn" id="nav-amt">Amount</div>
            <div class="nav-btn" id="nav-sch">School</div>
            <div class="nav-btn" id="nav-ind">Industry</div>
        </div>
    </div>
    <div class="page-sec" id="map-sec">
        <div id="native-map" class="viz-board"></div>
        <div class="viz-panel" id="map-controls"></div>
    </div>
    <div class="page-sec" id="state-sec">
        <div id="state-map" class="viz-board"></div>
        <div class="viz-panel" id="state-sub">
            <div class="sub-age" id="state-age-sub"></div>
            <div class="sub-indst" id="state-indst-sub"></div>
            <div id="state-paramt-sub"></div>
        </div>
    </div>
    <div class="page-sec" id="age-sec">
        <div id="age-board" class="viz-board"></div>
        <div class="viz-panel">
            <div class="sub-indst" id="age-indst-sub"></div>
            <div class="sub-map" id="age-map-sub"></div>
        </div>
    </div>
    <div class="page-sec" id="traf-sec">
        <div id="traf-board" class="viz-board"></div>
        <div class="viz-panel">
            <div class="sub-age" id="traf-age-sub"></div>
            <div class="sub-map" id="traf-map-sub"></div>
            <div class="sub-indst" id="traf-indst-sub"></div>
        </div>
    </div>
    <div class="page-sec" id="raid-sec">
        <div id="raid-board" class="viz-board"></div>
        <div class="viz-panel">
            <div id="sub-raid"></div>
        </div>
    </div>
    <div class="page-sec" id="amt-sec">
        <div id="amount-board" class="viz-board"></div>
        <div class="viz-panel">
            <div id="sub-amount-1"></div>
            <div id="sub-amount-2"></div>
        </div>
    </div>
    <div class="page-sec" id="sch-sec">
        <div id="school-board" class="viz-board"></div>
        <div class="viz-panel">
        </div>
    </div>
    <div class="page-sec" id="ind-sec">
        <div id="indst-board" class="viz-board"></div>
        <div class="viz-panel">
            <div id="indst-sub"></div>
        </div>
    </div>
</body>
<script type="text/javascript">
Data.init(raw_data);


var board_width = d3.select('.viz-board').style('width').slice(0, -2);
var board_height = d3.select('.viz-board').style('height').slice(0, -2);

var map_controls_width = d3.select('#map-controls').style('width').slice(0, -2);
var map_controls_height = d3.select('#map-controls').style('height').slice(0, -2);


var sub_indst_width = d3.select('.sub-indst').style('width').slice(0, -2);
var sub_indst_height = d3.select('.sub-indst').style('height').slice(0, -2);


var sub_age_width = d3.select('.sub-age').style('width').slice(0, -2);
var sub_age_height = d3.select('.sub-age').style('height').slice(0, -2);


var sub_map_width = d3.select('.sub-map').style('width').slice(0, -2);
var sub_map_height = d3.select('.sub-map').style('height').slice(0, -2);

var sub_raid_width = d3.select('#sub-raid').style('width').slice(0, -2);
var sub_raid_height = d3.select('#sub-raid').style('height').slice(0, -2);



//MAPS -------------------------------------------


function mapHeatmap(val, data) {

    mapboxgl.accessToken = 'pk.eyJ1IjoicGJzaGd0aG0iLCJhIjoiY2poaXl5NGkxMGRnazM2a2R1Z2VoOHFpNSJ9.oBXuyfoi8qB-paCmQpk8pQ';

    map = new mapboxgl.Map({
        container: val + '-map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [81.590, 23.308],
        zoom: 3.85,
        maxZoom: 9,
        maxBounds: [
            [64.871, 6.942],
            [98.308, 37.891]
        ]
    });

    map.on('load', function() {

        map.addSource('heatmap', {
            "type": "geojson",
            "data": data['point']
        });

        map.addSource('linemap', {
                  "type": "geojson",
                  'lineMetrics': true,
                  "data": data['line']
        });


        //heatmap init
        ///*
        map.addLayer({
            "id": "heatmap-layer",
            "type": "heatmap",
            "source": "heatmap",
            "paint": {

                "heatmap-weight": [
                    "interpolate",
                    ["linear"],
                    ["get", "val"],
                    4, 1,
                    9, 1
                ],


                "heatmap-intensity": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    4, 0.3,
                    9, 0.3
                ],


                "heatmap-color": [
                    "interpolate",
                    ["linear"],
                    ["heatmap-density"],
                    0, "rgba(0,0,0,0)",
                    0.10, "#C5E1A5",
                    0.20, "#FFCA28",
                    0.30, "#FFA726",
                    0.99, "#FF7043",
                    1, "#ef5350"
                ],


                "heatmap-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    4, 10,
                    9, 30
                ],

                "heatmap-opacity": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    4, 1,
                    9, 1
                ],
            }
        }, 'waterway-label');
        //*/


        ///*
        map.addLayer({
            "id": "hm-circle-layer",
            "type": "circle",
            "source": "heatmap",
            "layout":{
                "visibility":"none"
            },
            "paint": {


                "circle-color": 'white',

                "circle-stroke-color": 'white',

                "circle-stroke-width": 0,

                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    4, 0,
                    7, 2,
                    9, 5
                ],

                "circle-opacity": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    4, 0,
                    7, 0,
                    9, 0.8
                ],
            }
        }, 'waterway-label');


              //line init
              map.addLayer({
                    "id": "line-layer",
                    "type": "line",
                    "source": "linemap",
                    "paint": {
                        'line-width': [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            4, 1,
                            9, 2
                            ],
                        'line-color': '#FF7043',
                        'line-opacity':0.05,
                        'line-gradient': [
                            'interpolate',
                            ['linear'],
                            ['line-progress'],
                            0, "#FFD54F",
                            1, "#FF7043"
                            ]
                    }
              }, 'waterway-label');
        //*/

    })

}

//------------------------------------------------

function map_state(){
    state_svg=d3.select("#state-map").append("svg:svg")
    .attr("width", board_width)
    .attr("height",  board_height)
    .append("svg:g")
    


    var proj = d3.geo.mercator();
    var path = d3.geo.path().projection(proj);

    proj.scale(7500);
    proj.translate([-1400, 800]);




    var st_type=['from','to']
    var st_btn_txt={'from':'Factory','to':'Native'}

    

    state_svg.selectAll('state-btns')
    .data(st_type)
    .enter()
    .append('rect')
    .attr('fill','#CFD8DC')
    .attr('class','st-btn')
    .attr('id',function(d){return 'st-btn-'+d})
    .attr('x',function(d,i){return 200+100*i})
    .attr('y',670)
    .attr('height',30)
    .attr('width',70)
    .attr('rx',15)
    .attr('ry',15)
    .attr('cursor','pointer')
    .on('click',st_type_click)


    state_svg.selectAll('state-btns-txt')
    .data(st_type)
    .enter()
    .append('text')
    .attr('x',function(d,i){return 200+100*i+35})
    .attr('y',670+10)
    .attr('class','st-btnt')
    .attr('id',function(d){return 'st-btnt-'+d})
    .attr("dy", "10px")
    .attr('text-anchor','middle')
    .attr('fill','#546E7A')
    .style("font-size", "14px")
    .style('font-family', 'Arial')
    .text(function(d){return st_btn_txt[d]})
    .attr('cursor','pointer')
    .on('click',st_type_click)


    curr_st='from'

    d3.select('#st-btn-from').attr('fill','#4FC3F7')
    d3.select('#st-btnt-from').attr('fill','white')

    function st_type_click(){
        var _id=d3.select(this).attr('id').split('-')[2]
        curr_st=_id
        plot_st_data(sel_state)

        d3.selectAll('.st-btn').attr('fill','#CFD8DC')
        d3.select('#st-btn-'+_id).attr('fill','#4FC3F7')

        d3.selectAll('.st-btnt').attr('fill','#546E7A')
        d3.select('#st-btnt-'+_id).attr('fill','white')
    }

    var state_map = state_svg.selectAll("path")
        .data(india_geo.features)

    var entering = state_map.enter()
        .append("path");

    state_map.merge(entering)
        .attr('d',path)
        .attr('id',function(d){return 'state-'+d.id.replace(' ','_')})
        .attr('class','statemap-states')
        .on('click',state_map_click)
        .transition().duration(500)
        .style('stroke', 'white')
        .style('stroke-width', 1)
        .style("fill", '#CFD8DC')
        .style("opacity", 0.7)
        
    
    var curr_st_dict={
        'from':'raid',
        'to':'native'
    }

    function state_map_click(){

        var _id=d3.select(this).attr('id').split('-')[1].replace('_',' ')
        sel_state=_id
        plot_st_data(sel_state)
        
    }


    function plot_st_data(st){


        subplot_age(curr_st_dict[curr_st]+'_v_area', sel_state, state_age_svg,'Children from Maharashtra')
        subplot_indst(curr_st_dict[curr_st]+'_v_area', sel_state, state_indst_svg)
        subplot_amount(
            Data.subPlot(curr_st_dict[curr_st]+'_v_area',sel_state,'paramt'),
            state_paramt_svg,'Traffick price')


        d3.selectAll('.statemap-states').style('fill','#CFD8DC')
        
        var data=Data.stateStats(st)
        
        var st_data=data[curr_st]
        var f_max=st_data.reduce((max,x)=>max>x[1]?max:x[1],0)
        

        for(var i=0;i<st_data.length;i++){
            
            var s=st_data[i][0].replace(' ','_')
            var clr_dict={
                'from':d3.interpolateOranges(0.2+0.5*(st_data[i][1]/f_max)),
                'to':d3.interpolateBlues(0.3+0.5*(st_data[i][1]/f_max))
            }

            d3.select('#state-'+s).style('fill',clr_dict[curr_st]) 

        }

        d3.selectAll(".state-text-name").remove();
        d3.selectAll(".state-text-count").remove();

        d3.selectAll(".state-title").remove();
        d3.selectAll(".state-title-desc").remove();


        if(curr_st=='to')
            curr_st_list=['From','To']
        else
            curr_st_list=['To','From']

        state_svg.selectAll("state-title")
        .data(curr_st_list)
        .enter()
        .append('text')
        .attr('class','state-title-desc')
        .attr("x", 500)
        .attr("y", function(d,i){return 350+50*i})
        .attr("dy", "10px")
        .style("font-size", "16px")
        .style('fill','#78909C')
        .style('font-style','italic')
        .style('font-family', 'Arial')
        .text(function(d){return d});

        state_svg
        .append('text')
        .attr("x", 500)
        .attr("y", 370)
        .attr("class","state-title")
        .attr("dy", "10px")
        .style("font-size", "18px")
        .style('fill','#2196F3')
        .style('font-family', 'Arial')
        .text(sel_state);


        state_svg.selectAll("name")
        .data(st_data)
        .enter()
        .append('text')
        .attr('class','state-text-name')
        .attr("x", 500)
        .attr("y", function(d, i) { return 420 + 20 * i })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .text(function(d) { return d[0]; });


        state_svg.selectAll("count")
        .data(st_data)
        .enter()
        .append('text')
        .attr('class','state-text-count')
        .attr('text-anchor','end')
        .attr("x", 650)
        .attr("y", function(d, i) { return 420 + 20 * i })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#607D8B')
        .text(function(d) { return d[1]; });


        d3.select('#state-'+st.replace(' ','_')).style('fill','#607D8B')
        
    }
    plot_st_data(sel_state)

    
}

//MAIN PLOTS -------------------------------------

//AGE PLOT ------------
function age_plot() {

    age_svg = d3.select("#age-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height)
        .style('background-color', 'white')
        .append('g')

    var age_bins = Data.age_dist()[0];
    var since_bins = Data.age_dist()[1];

    age_svg.selectAll('text')
        .data(age_bins)
        .enter().append('text')
        .attr('id', function(d, i) { return 'age-txt-' + i })
        .attr('class', 'age-txt')
        .attr('text-anchor', 'middle')
        .attr("x", function(d, i) { return 62 + i * 30 })
        .attr("y", 410)
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .text(function(d, i) { return i + 1; })
        .attr('cursor','pointer')
        .on('mouseover', age_mouseover)
        .on('mouseout', age_mouseout)
        .on('click', age_click)



    function agebars_plot(data,clr) {
        
        var scale=1;
        var max=data.reduce((max,i)=>max>i?max:i,0)
        scale=250/max
        var age_bars = age_svg.selectAll("rect")
            .data(data)

        var entering = age_bars.enter()
            .append('rect')

        age_bars.merge(entering)
            .on('mouseover', age_mouseover)
            .on('mouseout', age_mouseout)
            .on('click', age_click)
            .transition().duration(500)
            .attr('id', function(d, i) { return 'age-bar-' + i })
            .attr('class', 'age-age-bar')
            .attr("fill", clr)
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("x", function(d, i) { return 50 + i * 30 })
            .attr("width", 25)
            .attr('opacity', 0.5)
            .attr("y", function(d, i) { return 400 - d*scale; })
            .attr("height", function(d, i) { return d*scale; })
            
    }


    var age_btn = ['since','age']

    for(var k=0;k<10;k++){
    age_svg.selectAll('age-btns')
        .data(age_btn)
        .enter()
        .append('circle')
        .attr('class',function(d){return 'age-btn '+'ab-'+d})
        .attr('fill', '#CFD8DC')
        .attr('cx', function(d, i) { return 7*k+300 + i * 150 })
        .attr('cy', 600)
        .attr('r', 17)
        .attr('cursor','pointer')
        .on('click', age_btn_click)
    }

    var ag_btn_t=[['since','Trafficked'],['age','Rescued']]
    age_svg.selectAll('btn-txt')
        .data(ag_btn_t)
        .enter().append('text')
        .attr('class', function(d, i) { return 'age-btnt '+'abt-'+d[0] })
        .attr('text-anchor', 'middle')
        .attr("x", function(d, i) { return 332.5 + i * 150 })
        .attr("y", 596)
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#78909C')
        .attr('cursor','pointer')
        .text(function(d, i) { return d[1]})
        .on('click', age_btn_click)
        


    var agedata_dict = {
        'age': [age_bins,'#FFB74D'],
        'since': [since_bins,'#4DD0E1']
    }
    agebars_plot(age_bins,'#FFB74D');
    d3.selectAll('.ab-age').attr('fill','#90CAF9');
    d3.selectAll('.abt-age').attr('fill','white');

    function age_btn_click() {

        var _id = d3.select(this).attr('class').split('-')[2]
        console.log(_id)
        agebars_plot(agedata_dict[_id][0],agedata_dict[_id][1])

        d3.selectAll('.age-btn').attr('fill','#CFD8DC')
        d3.selectAll('.ab-'+_id).attr('fill','#90CAF9')

        d3.selectAll('.age-btnt').attr('fill','#78909C')
        d3.selectAll('.abt-'+_id).attr('fill','white')
    }

    function age_mouseover() {

        var _id = d3.select(this).attr('id').split('-')[2]
        if (parseInt(_id) + 1 == curr_age) return;
        d3.select('#since-bar-' + _id)
            .attr('opacity', 0.8)
        d3.select('#age-bar-' + _id)
            .attr('opacity', 0.8)
        d3.select('#age-txt-' + _id)
            .attr('fill', '#546E7A')

    }

    function age_mouseout() {

        var _id = d3.select(this).attr('id').split('-')[2]
        if (parseInt(_id) + 1 == curr_age) return;
        d3.select('#since-bar-' + _id)
            .attr('opacity', 0.5)
        d3.select('#age-bar-' + _id)
            .attr('opacity', 0.5)
        d3.select('#age-txt-' + _id)
            .attr('fill', '#B0BEC5')

    }

    function age_click() {

        var _id = curr_age - 1

        d3.select('#since-bar-' + _id)
            .attr('opacity', 0.5)
        d3.select('#age-bar-' + _id)
            .attr('opacity', 0.5)
        d3.select('#age-txt-' + _id)
            .attr('fill', '#B0BEC5')


        var _id = d3.select(this).attr('id').split('-')[2]
        curr_age = parseInt(_id) + 1


        d3.select('#since-bar-' + _id)
            .attr('opacity', 1)
        d3.select('#age-bar-' + _id)
            .attr('opacity', 1)
        d3.select('#age-txt-' + _id)
            .attr('fill', '#546E7A')

        subplot_indst("age", curr_age, age_indst_svg);
        subplot_map("age", curr_age, 'native', age_map_svg);

    }

}
//---------------------
//TRAF PLOT -----------
function traf_plot() {


    var month_name = ['Jan-Feb', 'Mar-Apr', 'May-Jun', 'Jul-Aug', 'Sep-Oct', 'Nov-Dec']

    traf_svg = d3.select("#traf-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height)
        .style('background-color', 'white')
        //.call(d3.zoom().on("zoom", function() {
        //    traf_svg.attr("transform", d3.event.transform)
        //}))
        //.append("g")



    var month_data = Data.traffickDate();
    var colorise = d3.scaleSequential().domain([-50, 270])
        .interpolator(d3.interpolateInferno);


    var scale = d3.scaleLinear()
                  .domain([-250, 250])
                  .range([500, 0]);

    var y_axis = d3.axisLeft()
                  .scale(scale)
                  .ticks(10)


    function customYAxis(g) {
        g.call(y_axis);
        
        g.selectAll("path")
        .attr("opacity", "0")

        g.selectAll("line")
        .attr("stroke", "#90A4AE")


        g.selectAll("text")
        .attr("fill", "#90A4AE")
        .text(function(d){return d<0?-d:d})
    }


        traf_svg.append('g')
        .attr('class','y axis')
        .attr("transform", "translate(30, 50)")
        .call(customYAxis);

    


    var traf_box = traf_svg.selectAll("traf-box")
        .data(month_data).enter()
        .append("rect")
        .attr('id', function(d, i) { return 'traf-box-' + i })
        .attr("fill", 'white')
        .attr("x", function(d, i) { return 0 + d[0] * 13 - 50 + 6.5 })
        .attr("width", 100)
        .attr('stroke', function(d) { return colorise(d[1]) })
        .attr('stroke-width', 2)
        .attr('rx', 8)
        .attr('ry', 8)
        .attr('opacity', 0.9)
        .attr('display', 'none')
        .attr("y", 285)
        .attr("height", 30)



    var traf_label = traf_svg.selectAll("traf-label")
        .data(month_data).enter()
        .append("text")
        .attr('id', function(d, i) { return 'traf-label-' + i })
        .attr('text-anchor', 'middle')
        .attr("x", function(d, i) { return 0 + d[0] * 13 + 6.5 })
        .attr("y", 295)
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr("fill", function(d) { return colorise(d[1]) })
        .attr('opacity', 0)
        .text(function(d) { return month_name[d[0] % 6] + ' ' + (10 + parseInt(d[0] / 6)) })


    var bars = traf_svg.selectAll("bar")
        .data(month_data).enter()
        .append("rect")
        .attr('id', function(d, i) { return 'traf-bar-' + i })
        .attr("fill", function(d) { return colorise(d[1]) })
        .attr("x", function(d, i) { return 0 + d[0] * 13 })
        .attr("width", 13)
        .attr('stroke', 'white')
        .attr('stroke-width', 5)
        .attr('rx', 4)
        .attr('ry', 4)
        .attr('opacity', 0.5)
        .attr("y", function(d, i) { return 300 - d[1]; })
        .attr("height", function(d, i) { return d[1] * 2; })
        .on('mouseover', traf_mouseover)
        .on('mouseout', traf_mouseout)
        .on('click', traf_click)


    ///*
    var central = traf_svg
        .append('line')
        .attr("x1", 000)
        .attr("x2", 800)
        .attr("y1", 300)
        .attr("y2", 300)
        .style("stroke", "white")
        .attr('opacity', 0.5)
        .style("stroke-linecap", "round")
        .style("stroke-width", 15);
    //*/


    var central_marks = traf_svg.selectAll('central-marks')
        .data(month_data).enter()
        .append('rect')
        .attr("x", function(d, i) { return 0 + d[0] * 13 - 1 })
        .attr("width", 2)
        .attr('fill', '#607D8B')
        .attr("y", function(d, i) { return 300 - 5 })
        .attr("height", function(d, i) { return (d[0] % 6 == 0) ? 10 : 0 })


    var central_label = traf_svg.selectAll("central-label")
        .data(month_data).enter()
        .append("text")
        .attr('text-anchor', 'middle')
        .attr("x", function(d, i) { return 0 + d[0] * 13 + 13 })
        .attr("y", 295)
        .attr("dy", "10px")
        .style("font-size", function(d, i) { return (d[0] % 6 == 2) ? "12px" : '0px' })
        .style('font-family', 'Arial')
        .attr("fill", '#455A64')
        .text(function(d) { return (2010 + parseInt(d[0] / 6)) })



    function traf_mouseover() {
        var _id = d3.select(this).attr('id').split('-')[2]


        if (_id == curr_traf) return
        d3.select('#traf-bar-' + _id)
            .attr('opacity', 1)

        d3.select('#traf-box-' + _id)
            .attr('display', 'block')

        d3.select('#traf-label-' + _id)
            .attr('opacity', 1)

        d3.select('#traf-box-' + _id).raise()
        d3.select('#traf-label-' + _id).raise()
    }

    function traf_mouseout() {

        var _id = d3.select(this).attr('id').split('-')[2]

        if (_id == curr_traf) return
        d3.select('#traf-bar-' + _id)
            .attr('opacity', 0.5)

        d3.select('#traf-box-' + _id)
            .attr('display', 'none')

        d3.select('#traf-label-' + _id)
            .attr('opacity', 0)

        d3.select('#traf-box-' + _id).lower()
        d3.select('#traf-label-' + _id).lower()
    }

    function traf_click() {

        var _id = curr_traf
        d3.select('#traf-bar-' + _id)
            .attr('opacity', 0.5)

        d3.select('#traf-box-' + _id)
            .attr('display', 'none')

        d3.select('#traf-label-' + _id)
            .attr('opacity', 0)



        var d = (0 + parseInt(d3.select(this).attr('x'))) / 13
        subplot_age('t_date', d, traf_age_svg)
        subplot_indst("t_date", d, traf_indst_svg);
        subplot_map("t_date", d, "native", traf_map_svg);

        var _id = d3.select(this).attr('id').split('-')[2]
        curr_traf = _id
        d3.select('#traf-bar-' + _id)
            .attr('opacity', 1)

        d3.select('#traf-box-' + _id)
            .attr('display', 'block')

        d3.select('#traf-label-' + _id)
            .attr('opacity', 1)

    }
}
//---------------------
//RAID PLOT -----------

function raid_plot() {


    var zoom = d3.zoom()
        .on('zoom', function() {
            raid_svg.attr('transform', d3.event.transform);
        })

    function move(pan_x) {
        zoom.translateTo(raid_svg_g, -20 + 4.65 * (pan_x) + board_width / 2, board_height / 2);
    }

    raid_svg_g = d3.select("#raid-board")

    raid_svg = raid_svg_g
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height / 1.5)
        .append("g")

    raid_scale_svg = d3.select("#raid-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height / 3)
        .append("g")

    var r_data = Data.raidDist();
    var cir_data = []
    var line_data = []
    for (var i = 0; i < r_data.length; i++) {
        var x = 10 + i * 14;
        var y = undefined
        for (var j = 0; j < r_data[i].length; j++) {
            y = j * 8;
            cir_data.push([x, y, r_data[i][j]])
        }
        line_data.push([x, y])
    }


    var a = Array(170).fill(0).map((d, i) => i)

    //guide line
    for (var i = 0; i < line_data.length; i++) {
        if (line_data[i][1] == undefined) continue
        raid_svg
            .append('line')
            .attr("x1", -1300 + line_data[i][0])
            .attr("x2", -1300 + line_data[i][0])
            .attr("y1", 385)
            .attr("y2", 370 - line_data[i][1])
            .style("stroke", "#F4511E")
            .attr('opacity', 0.1)
            .style("stroke-linecap", "round")
            .style("stroke-width", 1);
    }

    //masks
    var raid_mask_dots = raid_svg.selectAll('dots')
        .data(cir_data).enter()
        .append('circle')
        .attr('cx', function(d) { return -1300 + d[0] })
        .attr('cy', function(d) { return 370 - d[1] })
        .attr('r', function(d) { return 3 + d[2] / 6 })
        .attr('fill', 'white')
        .attr('opacity', 1)

    //dots
    var raid_dots = raid_svg.selectAll('dots')
        .data(cir_data).enter()
        .append('circle')
        .attr('class', function(d) { return 'raid-dots-' + (d[0] - 10) / 14 })
        .attr('id', function(d) { return 'raiddots-' + d[1] + '-' + d[0] })
        .attr('cx', function(d) { return -1300 + d[0] })
        .attr('cy', function(d) { return 370 - d[1] })
        .attr('r', function(d) { return 2 + d[2] / 6 })
        .attr('fill', '#EF6C00')
        .attr('opacity', 0.3)
        .attr('stroke', '#FFCC80')
        .attr('stroke-width', 0)
        .on('mouseover', raid_dot_mouseover)
        .on('mouseout', raid_dot_mouseout)

    //months
    for (var i = 0; i < line_data.length; i++) {
        raid_svg
            .append('rect')
            .attr('id', 'raid-months-' + (line_data[i][0] - 10) / 14)
            .attr("x", -1300 + line_data[i][0] - 6.5)
            .attr("y", 385)
            .attr('rx', 6.5)
            .attr('ry', 6.5)
            .attr('width', 14)
            .attr('height', 30)
            .attr('fill', '#CFD8DC')
            .style("stroke", "white")
            .style("stroke-width", 3)
            .attr('opacity', 0.6)
            .on('mouseover', raid_month_mouseover)
            .on('mouseout', raid_month_mouseout)
            .on('click', raid_month_click)
    }

    //scale
    var dots_scale = raid_scale_svg.selectAll('dots')
        .data(cir_data).enter()
        .append('circle')
        .attr('cx', function(d) { return 130 + (d[0]) / 5 })
        .attr('cy', function(d) { return 60 + (300 - d[1]) / 5 })
        .attr('r', function(d) { return (3 + d[2] / 7) / 5 })
        .attr('fill', '#EF6C00')
        .attr('opacity', 0.7)


    var a = Array(170).fill(0).map((d, i) => i)

    raid_scale_svg
        .append('line')
        .attr("x1", 120)
        .attr("x2", 610)
        .attr("y1", 131)
        .attr("y2", 131)
        .style("stroke", "#B0BEC5")
        .attr('opacity', 1)
        .style("stroke-linecap", "round")
        .style("stroke-width", 0.8);

    for (var i = 0; i < a.length; i++) {

        if (a[i] % 12 != 0) continue;


        raid_scale_svg
            .append("text")
            .attr("x", 137 + 14 * a[i] / 5)
            .attr("y", 136)
            .attr("dy", "8px")
            .style("font-size", '9px')
            .style('font-family', 'Arial')
            .attr("fill", '#B0BEC5')
            .text((a[i] / 12 < 14) ? (a[i] / 12) + 2005 : "")


        raid_scale_svg
            .append('line')
            .attr("x1", 130 + 14 * a[i] / 5)
            .attr("x2", 130 + 14 * a[i] / 5)
            .attr("y1", 131)
            .attr("y2", 145)
            .style("stroke", "#B0BEC5")
            .attr('opacity', 1)
            .style("stroke-linecap", "round")
            .style("stroke-width", 0.8);
    }


    var drag = d3.drag().subject(function(d) {
            return d == null ? { x: d3.event.x, y: d3.event.y } : d;
        })
        .on("start", onStart)
        .on("drag", onDrag)
        .on("end", onEnd);


    var scale_window = raid_scale_svg
        .append('rect')
        .datum({ x: 390 })
        .attr('x', 390)
        .attr('y', 30)
        .attr('width', 140)
        .attr('height', 100)
        .attr('opacity', 0.2)
        .attr('fill', '#FF9800')
        .call(drag);


    function onStart() {
        d3.select(this).raise().classed("active", true);
    }

    function onDrag(d) {
        if (d3.event.x < 110 || d3.event.x > 490) return;
        d3.select(this).attr("x", (d.x = d3.event.x));
        move(d3.event.x - 390)
    }

    function onEnd() {
        d3.select(this).classed("active", false);
    }


    function raid_month_mouseover() {
        var _id = d3.select(this).attr('id').split('-')[2]
        if (_id == curr_raid_month) return;
        d3.selectAll('.raid-dots-' + _id)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.8)

        d3.select('#raid-months-' + _id)
            .style('fill', '#FFC107')
    }

    function raid_month_mouseout() {

        var _id = d3.select(this).attr('id').split('-')[2]
        if (_id == curr_raid_month) return;
        d3.selectAll('.raid-dots-' + _id)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.3)
        d3.select('#raid-months-' + _id)
            .style('fill', '#CFD8DC')
    }

    function raid_month_click() {
        var _id = curr_raid_month;
        d3.selectAll('.raid-dots-' + _id)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.3)
        d3.select('#raid-months-' + _id)
            .style('fill', '#CFD8DC')

        var _id = d3.select(this).attr('id').split('-')[2]
        curr_raid_month = _id

        d3.selectAll('.raid-dots-' + _id)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.8)

        d3.select('#raid-months-' + _id)
            .style('fill', '#FFC107')


        var month_data = Data.r_month_data(_id);
        subplot_raid(month_data)
    }

    function raid_dot_mouseover() {
        var _id = d3.select(this).attr('id').split('-')[2]

        d3.select(this)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.8)

        d3.select('#raid-months-' + _id)
            .style('fill', '#FFC107')
    }

    function raid_dot_mouseout() {
        var _id = d3.select(this).attr('id').split('-')[2]
        if (_id == curr_raid_month) return;
        d3.select(this)
            .attr('fill', '#EF6C00')
            .attr('opacity', 0.3)
        d3.select('#raid-months-' + _id)
            .style('fill', '#CFD8DC')
    }
}
//---------------------

// AMOUNT PLOT
function amount_plot() {
    var amt = Data.amountDist();
    var income = amt['income']
    var paramt = amt['paramt']
    var wage = amt['wage']
    var clr = ['#AB47BC', '#673AB7', '#42A5F5', '#26C6DA']

    amount_svg = d3.select("#amount-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height)
        .style('background-color', 'white')
        .append('g')

    var inc_dict = []
    for (var i = 0; i < 160; i++) {
        inc_dict.push([Math.floor(i / 4), (i % 4) + 1, 0, Math.floor(i / 4) * 5000])
    }
    var inc_data = amt['income_h']

    for (var i = 0; i < inc_data.length; i++) {
        var j = inc_data[i][0] * 4
        var k = inc_data[i][1] - 1
        inc_dict[k + j] = inc_data[i]
    }

    var par_dict = []
    for (var i = 0; i < 160; i++) {
        par_dict.push([Math.floor(i / 4), (i % 4) + 1, 0, Math.floor(i / 4) * 1000])
    }
    var par_data = amt['paramt_h']
    for (var i = 0; i < par_data.length; i++) {
        var j = par_data[i][0] * 4
        var k = par_data[i][1] - 1
        par_dict[k + j] = par_data[i]
    }

    var wag_dict = []
    for (var i = 0; i < 160; i++) {
        wag_dict.push([Math.floor(i / 4), (i % 4) + 1, 0, Math.floor(i / 4) * 50])
    }
    var wag_data = amt['wage_h']
    for (var i = 0; i < wag_data.length; i++) {
        var j = wag_data[i][0] * 4
        var k = wag_data[i][1] - 1
        wag_dict[k + j] = wag_data[i]
    }


    //////////////
    var sample_list = Array(40).fill(0)

    var income_list = sample_list.map(x => [0, 0])
    for (var i = 1; i < income.length; i++) {
        if (income[i][0] < 0) continue
        var inc = income[i][0] / 5000;
        if (inc > 39) inc = 39
        income_list[inc][0] += income[i][1]
        income_list[inc][1] = income[i][0]
    }


    var paramt_list = sample_list.map(x => [0, 0])

    for (var i = 1; i < paramt.length; i++) {

        if (paramt[i][0] < 0) continue
        var inc = paramt[i][0] / 1000;
        if (inc > 39) inc = 39
        paramt_list[inc][0] += paramt[i][1]
        paramt_list[inc][1] = paramt[i][0]
    }


    var wage_list = sample_list.map(x => [0, 0])
    for (var i = 1; i < wage.length; i++) {

        if (wage[i][0] < 0) continue
        var inc = wage[i][0] / 50;
        if (inc > 39) inc = 39
        wage_list[inc][0] += wage[i][1]
        wage_list[inc][1] = wage[i][0]
    }

    var amt_btn = ['income', 'paramt', 'wage']
    var amt_dict = {
        'income': income_list,
        'paramt': paramt_list,
        'wage': wage_list
    }
    var amt_sub_dict = {
        'income': [paramt_list, wage_list],
        'paramt': [income_list, wage_list],
        'wage': [income_list, paramt_list]
    }
    amount_svg.selectAll("btn")
        .data(amt_btn).enter()
        .append("circle")
        .attr('id', function(d) { return 'amt-btn-' + d })
        .attr('class', 'amtbtn')
        .attr("fill", '#CFD8DC')
        .attr("stroke", '#90A4AE')
        .attr("stroke-width", 2)
        .attr("cx", function(d, i) { return 200 + i * 120 })
        .attr("width", 80)
        .attr('rx', 8)
        .attr('ry', 8)
        .attr("cy", 600)
        .attr("r", 20)
        .attr("height", 30)
        .attr('opacity', 0.5)
        .on('click', amt_btn_click)


    function update_amount(amt, _id) {

        var amt_bar = amount_svg.selectAll('rect')
            .data(amt)

        var entering = amt_bar.enter()
            .append("rect");

        var max = amt.reduce((max, x) => max > x[2] ? max : x[2], 0)
        var scale = 300 / max

        amt_bar.merge(entering)
            .on('click', amt_bar_click)
            .transition().duration(500)
            .attr("fill", function(d) { return clr[d[1] - 1] })
            .attr('id', function(d) { return 'amtbar-' + _id + '-' + d[3] + '-' + d[0] })
            .attr('class', function(d) { return 'amtbar-' + d[0] })
            .attr("x", function(d, i) { return 50 + d[0] * 15 })
            .attr("width", 10)
            .attr('rx', 2)
            .attr('ry', 2)
            .attr("y", function(d) { return 500 - d[2] * scale })
            .attr("height", function(d) { return d[2] * scale })

    }


    function amt_btn_click() {
        var _id = d3.select(this).attr('id').split('-')[2]

        subplot_amount(amt_sub_dict[_id][0], amount1_sub_svg)
        subplot_amount(amt_sub_dict[_id][1], amount2_sub_svg)

        update_amount(amt_h_dict[_id], _id)

        d3.selectAll('.amtbtn')
            .attr("fill", '#CFD8DC')
            .attr("stroke", '#90A4AE')

        d3.select('#amt-btn-' + _id)
            .attr("fill", '#B3E5FC')
            .attr("stroke", '#1E88E5')

    }

    var amtsub_dict = {
        'income': ['paramt', 'wage'],
        'paramt': ['income', 'wage'],
        'wage': ['income', 'paramt']
    }

    var amt_h_dict = {
        'income': inc_dict,
        'paramt': par_dict,
        'wage': wag_dict
    }

    function amt_bar_click() {
        var _id = d3.select(this).attr('id').split('-');

        var amt = Data.amountSelDist(_id[1], parseInt(_id[2]))
        subplot_amount(amt[amtsub_dict[_id[1]][0]], amount1_sub_svg)
        subplot_amount(amt[amtsub_dict[_id[1]][1]], amount2_sub_svg)

        amount_svg.selectAll('rect')
            .transition().duration(100)
            .attr('fill', '#CFD8DC')

        d3.selectAll('.amtbar-' + _id[3])
            .transition().duration(100)
            .attr("fill", function(d) { return clr[d[1] - 1] })

        d3.select('#amt-btn-' + _id[1])
            .attr("fill", 'white')
            .attr("stroke", '#1E88E5')


    }

    d3.select('#amt-btn-income')
        .attr("fill", '#B3E5FC')
        .attr("stroke", '#1E88E5')
    update_amount(inc_dict, 'income')
    subplot_amount(paramt_list, amount1_sub_svg)
    subplot_amount(wage_list, amount2_sub_svg)
}
// ----------------------

function school_plot() {
    school_svg = d3.select("#school-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height)
        .style('background-color', 'white')
        .append('g')

    var sch = Data.getDict('school');
    var std = Data.getDict('class');
    std = std.map(x => [parseInt(x[0]), x[1]])
    std.sort(function(a, b) { return a[0] - b[0] })
    std.shift()


    var color = d3.scaleOrdinal(['#4DD0E1', '#AED581', '#FFD54F', '#984ea3', '#e41a1c']);
    var pie = d3.pie();

    sch = [3168, 1040, 125]
    // Generate the arcs
    var arc = d3.arc()
        .innerRadius(60)
        .outerRadius(80);

    //Generate groups
    var arcs = school_svg.selectAll("arc")
        .data(pie(sch))
        .enter()
        .append("g")
        .attr("class", "arc")
        .attr('transform', 'translate(300,200)')

    //Draw arc paths
    arcs.append("path")
        .attr("fill", function(d, i) {
            return color(i);
        })
        .attr("d", arc);


    school_svg.selectAll("btn")
        .data(std).enter()
        .append("rect")
        .attr("fill", '#26A69A')
        .attr("x", function(d, i) { return 200 + i * 35 })
        .attr("width", 25)
        .attr('rx', 3)
        .attr('ry', 3)
        .attr("y", function(d) { return 600 - d[1] / 3 })
        .attr("height", function(d) { return d[1] / 3 })
        .attr('opacity', 0.5)
}

function indust_plot() {
    indst_svg = d3.select("#indst-board")
        .append("svg")
        .attr("width", board_width)
        .attr("height", board_height)
        .style('background-color', 'white')
        .append('g')


    var ind_cat = Data.industryDist()
    var ind = []
    var ind_clrs = ['#FFCC80', '#C5E1A5', '#CE93D8', '#80DEEA', '#CFD8DC']

    for (var i = 0; i < ind_cat.length; i++)
        for (var j = 0; j < ind_cat[i].length; j++)
            ind.push([ind_cat[i][j][0], ind_cat[i][j][1], i])

    ind.sort(function(a, b) { return b[0] - a[0] })

    norm_ind = ind.slice(0, 20)
    norm_ind.push([ind.slice(20).reduce((sum, i) => sum + i[0], 0), 'Others', 4])

    indst_svg.selectAll('rect')
        .data(norm_ind)
        .enter()
        .append('rect')
        .attr('id', function(d) { return 'ind-bar-' + d[1] })
        .attr('fill', function(d) { return ind_clrs[d[2]] })
        .attr('x', 150)
        .attr('y', function(d, i) { return 100 + 27 * i })
        .attr('height', 10)
        .attr('width', function(d) { return d[0] / 8 })
        .on('click', ind_bar_click)


    indst_svg.selectAll('text')
        .data(norm_ind)
        .enter()
        .append('text')
        .attr("x", 140)
        .attr("y", function(d, i) { return 100 + 27 * i })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('text-anchor', 'end')
        .attr('fill', '#B0BEC5')
        .text(function(d) { return ind_dict[d[1]] })

    function ind_bar_click() {
        var _id = d3.select(this).attr('id').split('-')[2]
        subplot_indst_loc((_id))

    }
}

//------------------------------------------------






//SUB PLOTS --------------------------------------

//MAP CONTROLS -------
function map_controls() {

    map.on('load', function(){
        map.setLayoutProperty('line-layer','visibility','none')    
    });
    var heatmap_clrs = {
        'native': [
            "interpolate",
            ["linear"],
            ["heatmap-density"],
            0, "rgba(0,0,0,0)",
            0.10, "#C5E1A5",
            0.20, "#FFCA28",
            0.30, "#FFA726",
            0.99, "#FF7043",
            1, "#ef5350"
        ],
        'raid': [
            "interpolate",
            ["linear"],
            ["heatmap-density"],
            0, "rgba(0,0,0,0)",
            0.10, "#80DEEA",
            0.20, "#81D4FA",
            0.30, "#90CAF9",
            0.9999, "#7986CB",
            1, "#9575CD"
        ]

    }


    var age_bars = Array(20).fill(0)
    age_bars = age_bars.map((x, i) => i)


    var loc_dict=['native','raid','line']


    map_controls_svg.selectAll('loc-btn')
        .data(loc_dict)
        .enter()
        .append("rect")
        .attr("fill", "#ECEFF1")
        .attr('class', 'mc-loc')
        .attr('id', function(d){return 'mc-loc-'+d})
        .attr("x", function(d,i){return 10+100*i})
        .attr('width',80)
        .attr('height',30)
        .attr('rx',15)
        .attr('ry',15)
        .attr("y", 50)
        .attr('cursor','pointer')
        .on('click', mc_loc_click)

    map_controls_svg.selectAll('loc-text')
        .data(loc_dict)
        .enter()
        .append("text")
        .attr("fill", "#78909C")
        .attr('class', 'mc-loct')
        .attr('id', function(d){return 'mc-loct-'+d})
        .attr("x", function(d,i){return 10+100*i+40})
        .style('font-family', 'Arial')
        .style("font-size", "15px")
        .attr('text-anchor','middle')
        .attr("y", 50+20)
        .text(function(d){return d.charAt(0).toUpperCase() + 
           d.slice(1); })
        .attr('cursor','pointer')
        .on('click', mc_loc_click)

    map_controls_svg
        .append("text")
        .attr("x",10)
        .attr("y", 30)
        .style("font-size", "17px")
        .style('fill','#039BE5')
        .style('font-family', 'Arial')
        .text('Location type')

    

    function mc_loc_click() {
        var _id = d3.select(this).attr('id').split('-')[2]
        map_loc = _id
        
        if(_id=='line'){

            map.setLayoutProperty('heatmap-layer', 'visibility', 'none');
            map.setLayoutProperty('hm-circle-layer', 'visibility', 'none');
            map.setLayoutProperty('line-layer','visibility','visible')
        }
        else{
            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line']);

            map.setPaintProperty('heatmap-layer', 'heatmap-color', heatmap_clrs[_id])
            map.setLayoutProperty('line-layer','visibility','none')
            if(is_hm=='y'){
                map.setLayoutProperty('heatmap-layer', 'visibility', 'visible');
                map.setLayoutProperty('hm-circle-layer', 'visibility', 'visible');
            }
            else{
                map.setLayoutProperty('heatmap-layer', 'visibility', 'none');
                map.setLayoutProperty('hm-circle-layer', 'visibility', 'none');
            }
            
            
        }

        d3.selectAll('.mc-loc')
            .attr('fill', '#ECEFF1')

        d3.select('#mc-loc-'+_id)
            .attr('fill', '#4FC3F7')

        d3.selectAll('.mc-loct')
            .attr('fill', '#78909C')

        d3.select('#mc-loct-'+_id)
            .attr('fill', 'white')
    }



    
    map_controls_svg
        .append("text")
        .attr("fill", "#90A4AE")
        .attr("x", 8)
        .attr("y", 155)
        .style("font-size", "17px")
        .style('fill','#039BE5')
        .style('font-family', 'Arial')
        .text('Age')

    map_controls_svg
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x", 23)
        .style("font-size", "11px")
        .attr('text-anchor', 'middle')
        .style('font-family', 'Arial')
        .attr("y", 200)
        .text('All')

    map_controls_svg.selectAll('mc-age-text')
        .data(age_bars)
        .enter()
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x", function(d) { return 43 + d * 17 + 8.5 })
        .attr("y", 200)
        .style("font-size", "9px")
        .attr('text-anchor', 'middle')
        .style('font-family', 'Arial')
        .text(function(d) { return d + 1 })

    map_controls_svg.selectAll('mc-age-rect')
        .data(age_bars)
        .enter()
        .append("rect")
        .attr("fill", "#CFD8DC")
        .attr('stroke', 'white')
        .attr('stroke-width', 4)
        .attr('id', function(d) { return 'mc-age-' + (d + 1) })
        .attr('rx', 3)
        .attr('ry', 3)
        .attr("x", function(d) { return 43 + d * 17 })
        .attr("width", 17)
        .attr('opacity', 0.5)
        .attr("y", 180)
        .attr("height", 30)
        .on('mouseover', mc_age_mouseover)
        .on('mouseout', mc_age_mouseout)
        .on('click', mc_age_click)
        .attr('cursor','pointer')


    map_controls_svg
        .append("rect")
        .attr("fill", "#00BCD4")
        .attr('id', 'mc-age-all')
        .attr('rx', 5)
        .attr('ry', 5)
        .attr("x", 10)
        .attr("width", 30)
        .attr('opacity', 0.5)
        .attr("y", 180)
        .attr("height", 28)
        .on('mouseover', mc_age_all_mouseover)
        .on('mouseout', mc_age_all_mouseout)
        .on('click', mc_age_all_click)
        .attr('cursor','pointer')

    



    function mc_age_mouseover() {
        var _id = d3.select(this).attr('id').split('-')[2]
        if (parseInt(_id) == map_age) return;
        d3.select('#mc-age-' + _id)
            .attr('fill', '#00BCD4')
    }

    function mc_age_mouseout() {
        var _id = d3.select(this).attr('id').split('-')[2]
        if (parseInt(_id) == map_age) return;
        d3.select('#mc-age-' + _id)
            .attr('fill', "#CFD8DC")

    }

    function mc_age_click() {
        d3.select('#mc-age-all')
            .attr('fill', '#CFD8DC')

        var _id = map_age

        d3.select('#mc-age-' + _id)
            .attr('fill', "#CFD8DC")

        var _id = d3.select(this).attr('id').split('-')[2]
        d3.select('#mc-age-' + _id)
            .attr('fill', '#00BCD4')


        d3.select()
            .attr('fill', 'white')

        map_age = _id;
        var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
        map.getSource('heatmap').setData(new_crds['point']);
        map.getSource('linemap').setData(new_crds['line'])

    }


    function mc_age_all_mouseover() {
        d3.select(this)
            .attr('fill', '#00BCD4')

    }

    function mc_age_all_mouseout() {
        if (map_age == 0) return;

        d3.select(this)
            .attr('fill', '#CFD8DC')

    }

    function mc_age_all_click() {
        var _id = map_age

        d3.select('#mc-age-' + _id)
            .attr('fill', "#CFD8DC")

        d3.select(this)
            .attr('fill', '#00BCD4')
        map_age = 0;

        var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
        map.getSource('heatmap').setData(new_crds['point']);
        map.getSource('linemap').setData(new_crds['line'])

    }


    /*
    map_controls_svg
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x",15)
        .attr("y", 320)
        .attr('font-size','12px')
        .text('All')
    */

    map_controls_svg
        .append("text")
        .attr("fill", "#90A4AE")
        .attr("x", 8)
        .attr("y", 295)
        .style("font-size", "17px")
        .style('fill','#039BE5')
        .style('font-family', 'Arial')
        .text('Raid Month')

    var time_bars = Array(97).fill(0)
    time_bars = time_bars.map((x, i) => i)

    

    map_controls_svg.selectAll('time-text')
        .data(time_bars)
        .enter()
        .append("text")
        .attr("fill", "#90A4AE")
        .attr("x", function(d,i){return 10+d*4})
        .attr("y", 370)
        .attr('text-anchor','middle')
        .attr('font-size','9px')
        .text(function(d){return d%12==0?2011+d/12:""})


    map_controls_svg.selectAll('mc-time-rect')
        .data(time_bars)
        .enter()
        .append("rect")
        .attr("fill", "#CFD8DC")
        .attr('id', function(d) { return 'mc-time-' + (d + 1) })
        .attr('rx', 1)
        .attr('ry', 1)
        .attr("x", function(d) { return 10 + d * 4 })
        .attr("width", 2)
        .attr('opacity', 0.8)
        .attr("y", 330)
        .attr("height", 15)

    map_controls_svg.selectAll('time-t-rect')
        .data(time_bars.concat([96]))
        .enter()
        .append("rect")
        .attr("fill", "#CFD8DC")
        .attr("x", function(d,i){return 10+d*4+0.5})
        .attr("y", 330)
        .attr('height',function(d){return d%12==0?25:0})
        .attr('width',1)

    var drag = d3.drag().subject(function(d) {
            return d == null ? { x: d3.event.x, y: d3.event.y } : d;
        })
        .on("start", onStart)
        .on("drag", onDrag)
        .on("end", onEnd);

    map_controls_svg
        .append("rect")
        .attr("fill", "#4FC3F7")
        .attr('id', 'mc-time-r')
        .attr("x", 10 + map_time[0] * 4 - 1)
        .datum({ x: 10 + map_time[0] * 4 - 1 })
        .attr("width", (map_time[1] - map_time[0] + 1) * 4)
        .attr('opacity', 0.3)
        .attr("y", 330 - 7.5)
        .attr("height", 30)
        .style('cursor', 'grab')
        .call(drag)

    map_controls_svg
        .append("rect")
        .attr("fill", "#78909C")
        .attr('id', 'mc-time-r1')
        .attr('rx', 1)
        .attr('ry', 1)
        .attr("x", 10 + map_time[0] * 4 - 5)
        .datum({ x: 10 + map_time[0] * 4 - 5 })
        .attr("width", 8)
        .attr('opacity', 1)
        .attr("y", 330 + 2.5)
        .attr("height", 10)
        .style('cursor', 'ew-resize')
        .call(drag)

    map_controls_svg
        .append("rect")
        .attr("fill", "#78909C")
        .attr('id', 'mc-time-r2')
        .attr('rx', 1)
        .attr('ry', 1)
        .attr("x", 10 + map_time[1] * 4 - 1)
        .datum({ x: 10 + map_time[1] * 4 - 1 })
        .attr("width", 8)
        .attr('opacity', 1)
        .attr("y", 330 + 2.5)
        .attr("height", 10)
        .style('cursor', 'ew-resize')
        .call(drag)

    /*
    map_controls_svg
        .append("rect")
        .attr("fill", "#CFD8DC")
        .attr('id', 'mc-time-all')
        .attr('rx', 7)
        .attr('ry', 7)
        .attr("x", 10)
        .attr("width", 30)
        .attr('opacity', 0.5)
        .attr("y", 300)
        .attr("height", 30)
        .on('mouseover', mc_time_all_mouseover)
        .on('mouseout', mc_time_all_mouseout)
        .on('click', mc_time_all_click)
    */

    function mc_time_all_mouseover() {
        d3.select(this).attr('fill', '#80DEEA')
    }

    function mc_time_all_mouseout() {
        d3.select(this).attr('fill', '#CFD8DC')
    }

    function mc_time_all_click() {
        d3.select(this).attr('fill', '#80DEEA')
        map_time = [0, 95]

        d3.select('#mc-time-r1').datum().x = 10 + map_time[0] * 4 - 5;
        d3.select('#mc-time-r1').attr("x", 10 + map_time[0] * 4 - 5);

        d3.select('#mc-time-r').datum().x = 10 + map_time[0] * 4 - 5;
        d3.select('#mc-time-r').attr("x", 10 + map_time[0] * 4 + 4 - 5);
        d3.select('#mc-time-r').attr("width", map_time[1] * 4 + 4);

        d3.select('#mc-time-r2').datum().x = 10 + map_time[1] * 4 - 1;
        d3.select('#mc-time-r2').attr("x", 10 + map_time[1] * 4 - 1);

        var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
        map.getSource('heatmap').setData(new_crds['point']);
        map.getSource('linemap').setData(new_crds['line']);

    }

    function onStart() {
        d3.select(this).raise().classed("active", true);
    }

    function onDrag(d) {

        var _id = d3.select(this).attr('id').split('-')[2]
        if (_id == "r1") {


            if (d3.event.x < 10 - 1 || d3.event.x > 10 + map_time[1] * 4 - 5) return;

            var anchor = 10 + Math.floor(((d3.event.x - 10) / 4)) * 4;


            map_time[0] = parseInt((anchor - 10) / 4) + 1;

            d3.select('#mc-time-r1').attr("x", (d.x = anchor - 1));

            d3.select('#mc-time-r').datum().x = anchor + 4 - 1;
            d3.select('#mc-time-r').attr("x", (anchor + 4 - 1));
            d3.select('#mc-time-r').attr("width", (map_time[1] - map_time[0]) * 4 + 4);

            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line'])

        }


        if (_id == "r2") {


            if (d3.event.x < 10 + map_time[0] * 4 + 4 || d3.event.x > 390) return;

            var anchor = 10 + Math.ceil(((d3.event.x - 10) / 4)) * 4 - 1;

            d3.select('#mc-time-r2').attr("x", (d.x = anchor));

            map_time[1] = parseInt((anchor - 10) / 4) + 1;
            d3.select('#mc-time-r').attr("width", (map_time[1] - map_time[0]) * 4 + 4);
            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line'])

        }

        if (_id == "r") {


            var r = (map_time[1] - map_time[0]);

            if (d3.event.x < 10 || d3.event.x + r * 4 - 4 > 390) return;


            var anchor = 10 + Math.floor(((d3.event.x - 10) / 4)) * 4;
            d3.select('#mc-time-r').attr("x", (d.x = anchor - 1));


            d3.select('#mc-time-r1').datum().x = anchor - 4; - 1
            d3.select('#mc-time-r1').attr("x", (anchor - 4 - 1));

            d3.select('#mc-time-r2').datum().x = anchor + r * 4 - 1;
            d3.select('#mc-time-r2').attr("x", (anchor + r * 4 - 1));

            map_time[0] = parseInt((anchor - 10 - 4) / 4) + 1;
            map_time[1] = map_time[0] + r;

            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line'])

        }



        //var new_crds = Data.filterPoints(map_age, map_time)
        //map.getSource('heatmap').setData(new_crds['point']);map.getSource('linemap').setData(new_crds['line'])

    }

    function onEnd() {
        d3.select(this).classed("active", false);
    }


    map_controls_svg
        .append("text")
        .attr("fill", "#90A4AE")
        .attr("x", 8)
        .attr("y", 450)
        .style("font-size", "17px")
        .style('fill','#039BE5')
        .style('font-family', 'Arial')
        .text('Industries')


    var indst_r_list = ["Garment", "Hotel/Dhaba", "Footwear", "Handicraft", "Jute/Plastic/Rexin/Cloth Bags", "Cosmetic", "Domestic Servant", "Automobile/Transport", "Metal", "Retail Shop/Office", "Electrical & Electronics", "Leather", "Jewellery","_others", ""]

    var indst_c_list = ["Garment", "Hotel", "Footwear", "Handicraft", "Cloth Bags", "Cosmetic", "Servant", "Automobile", "Metal", "Retail Shop", "Electronics", "Leather","Jewellery","Others", "Unknown"]

    var ind_list = [];
    for (var i = 0; i < indst_r_list.length; i++) {
        ind_list.push([18 + parseInt(i / 5) * 120, 530 + 40 * (i % 5), indst_c_list[i]])
    }

    map_controls_svg.selectAll('mc-ind-text')
        .data(ind_list)
        .enter()
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x", function(d) { return d[0] + 35 })
        .attr("y", function(d) { return d[1] +2})
        .attr('text-anchor', 'middle')
        .style("font-size", "12px")
        .style('font-family', 'Arial')
        .text(function(d) { return d[2] })


    map_controls_svg.selectAll('mc-ind-ind')
        .data(ind_list)
        .enter()
        .append("rect")
        .attr('id', function(d, i) { return 'mc-ind-' + i })
        .attr("fill", "#80DEEA")
        .attr('stroke', '#00ACC1')
        .attr('stroke-width', 1)
        .attr('rx', 13)
        .attr('ry', 13)
        .attr("x", function(d) { return d[0] - 10 })
        .attr("y", function(d) { return d[1] - 16 })
        .attr('height', 26)
        .attr('width', 90)
        .attr('opacity', 0.3)
        .on('mouseover', mc_ind_mouseover)
        .on('mouseout', mc_ind_mouseout)
        .on('click', mc_ind_click)



    map_controls_svg
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x", 53)
        .attr("y", 475 +16)
        .attr('text-anchor', 'middle')
        .style("font-size", "12px")
        .style('font-family', 'Arial')
        .text('All')

    map_controls_svg.append("rect")
        .attr('id', 'mc-ind-all')
        .attr("fill", "#80DEEA")
        .attr('stroke', '#00ACC1')
        .attr('stroke-width', 1)
        .attr('rx', 11.5)
        .attr('ry', 11.5)
        .attr("x", 8)
        .attr("y", 475)
        .attr('height', 23)
        .attr('width', 90)
        .attr('opacity', 0.3)
        .on('mouseover', mc_ind_all_mouseover)
        .on('mouseout', mc_ind_all_mouseout)
        .on('click', mc_ind_all_click)


    map_controls_svg
        .append("text")
        .attr("fill", "#546E7A")
        .attr("x", 293)
        .attr("y", 475 +16)
        .attr('text-anchor', 'middle')
        .style("font-size", "12px")
        .style('font-family', 'Arial')
        .text('Clear')


    map_controls_svg.append("rect")
        .attr('id', 'mc-ind-clear')
        .attr("fill", "white")
        .attr('stroke', '#00ACC1')
        .attr('stroke-width', 1)
        .attr('rx', 11.5)
        .attr('ry', 11.5)
        .attr("x", 248)
        .attr("y", 475)
        .attr('height', 23)
        .attr('width', 90)
        .attr('opacity', 0.3)
        .on('mouseover', mc_ind_clear_mouseover)
        .on('mouseout', mc_ind_clear_mouseout)
        .on('click', mc_ind_clear_click)




    function mc_ind_mouseover() {
        var _id = parseInt(d3.select(this).attr('id').split('-')[2]);
        if (map_ind.indexOf(_id) != -1) return;
        d3.select('#mc-ind-' + _id).attr('fill', '#B2EBF2')
    }

    function mc_ind_mouseout() {
        var _id = parseInt(d3.select(this).attr('id').split('-')[2]);
        if (map_ind.indexOf(_id) != -1) return;
        d3.select('#mc-ind-' + _id).attr('fill', 'white')
    }

    function mc_ind_click() {
        var _id = parseInt(d3.select(this).attr('id').split('-')[2]);
        if (map_ind.indexOf(_id) == -1) {


            d3.select('#mc-ind-' + _id).attr('fill', '#80DEEA');
            map_ind.push(_id)

            if (map_ind.length == 15) d3.select('#mc-ind-all').attr('fill', '#80DEEA')
            if (map_ind.length != 1) d3.select('#mc-ind-clear').attr('fill', 'white')


            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line'])
        } else {

            if (map_ind.length == 1) return;
            d3.select('#mc-ind-all').attr('fill', 'white')
            d3.select('#mc-ind-' + _id).attr('fill', 'white');
            map_ind.splice(map_ind.indexOf(_id), 1)

            if (map_ind.length == 1)
                d3.select('#mc-ind-clear').attr('fill', '#80DEEA')

            var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
            map.getSource('heatmap').setData(new_crds['point']);
            map.getSource('linemap').setData(new_crds['line'])
        }


    }

    function mc_ind_all_mouseover() {
        if (map_ind.length == 15) return
        d3.select(this).attr('fill', '#B2EBF2')

    }

    function mc_ind_all_mouseout() {
        if (map_ind.length == 15) return
        d3.select(this).attr('fill', 'white')
    }

    function mc_ind_all_click() {

        if (map_ind.length == 15) return;
        d3.select(this).attr('fill', '#80DEEA')
        map_ind = Array(14).fill(0).map((x, i) => i)
        d3.select('#mc-ind-clear').attr('fill', 'white')

        for (var i = 0; i < map_ind.length; i++)
            d3.select('#mc-ind-' + i).attr('fill', '#80DEEA')
        var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
        map.getSource('heatmap').setData(new_crds['point']);
        map.getSource('linemap').setData(new_crds['line'])
    }



    function mc_ind_clear_mouseover() {
        if (map_ind.length == 1) return
        d3.select(this).attr('fill', '#B2EBF2')

    }

    function mc_ind_clear_mouseout() {
        if (map_ind.length == 1) return
        d3.select(this).attr('fill', 'white')
    }

    function mc_ind_clear_click() {

        if (map_ind.length == 1) return;
        d3.select(this).attr('fill', '#80DEEA')

        for (var i = 0; i < map_ind.length; i++)
            d3.select('#mc-ind-' + map_ind[i]).attr('fill', 'white')

        d3.select('#mc-ind-0').attr('fill', '#80DEEA')
        d3.select('#mc-ind-all').attr('fill', 'white')

        map_ind = [0]
        var new_crds = Data.filterPoints(map_age, map_time, map_ind, map_loc);
        map.getSource('heatmap').setData(new_crds['point']);
        map.getSource('linemap').setData(new_crds['line'])
    }


    //DONT UNCHECK ALL OPTION
    //HAVE UNCHECK ALL BUT ONE

}
//--------------------

//INDST SUB PLOT -----
function subplot_indst(src, val, board) {

    var s_ind = ["Garment", "Hotel/Dhaba", "Footwear", "Jute/Plastic/Rexin/Cloth Bags", "Handicraft", "Domestic Servant", "Cosmetic", "Stone Quarry", "Odd Jobs", "Automobile/Transport"]

    var s_ind_clean = ["Garment", "Hotel", "Footwear", "Cloth Bags", "Handicraft", "Domestic Servant", "Cosmetic", "Stone Quarry", "Odd Jobs", "Transport"]


    var data = Data.subPlot(src, val, "indst");
    var sum = data.reduce((sum, i) => sum + i[1], 0);
    var max = data.reduce((max,i)=>max>i[1]?max:i[1],0)

    var bar_ratio = Array(10).fill(0)
    for (var i = 0; i < data.length; i++) {
        var ind = s_ind.indexOf(data[i][0])
        if (ind == -1) continue;
        bar_ratio[ind] = data[i][1]
    }

    if(data.length!=0)
        bar_ratio = bar_ratio.map(x => 200*x / max)

    
    
    var scale = d3.scaleLinear()
                  .domain([0,max])
                  .range([20, 220]);

    var x_axis = d3.axisBottom()
                  .scale(scale)
                  .ticks(5)


    function customXAxis(g) {
        g.call(x_axis);
        
        g.selectAll("path")
        .attr("opacity", "0")

        g.selectAll("line")
        .attr("stroke", "#90A4AE")


        g.selectAll("text")
        .attr("fill", "#90A4AE")
    }


    var selected = d3.select('#title'+board.attr('id'));
    if (selected['_groups'][0][0] == null) { 
        board.append('g')
        .attr('class','x axis')
        .attr("transform", "translate(140, 210)")
        .call(customXAxis);

    } else { 
        board.select(".x.axis")
            .transition()
            .duration(500)
            .call(customXAxis);
    }


    d3.select('#title'+board.attr('id')).remove();
    d3.selectAll('.subage'+board.attr('id')).remove();

    board
        .append('text')
        .attr("x", sub_indst_width/2)
        .attr("y", 10)
        .attr('id','title'+board.attr('id'))
        .attr("dy", "10px")
        .style("font-size", "15px")
        .attr('text-anchor','middle')
        .style('font-family', 'Arial')
        .attr('fill', '#607D8B')
        .text('Industry distribution');



    board.selectAll('text-ind')
        .data(s_ind_clean)
        .enter().append('text')
        .attr('text-anchor', 'end')
        .attr('class','subage'+board.attr('id'))
        .attr("x", 145)
        .attr("y", function(d, i) { return 44 + 17 * i })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .text(function(d) { return d; });


    var sub_indst_bars = board.selectAll("rect")
        .data(bar_ratio)

    var entering = sub_indst_bars.enter()
        .append("rect");

    sub_indst_bars.merge(entering)
        .transition().duration(500)
        .attr("fill", "#90CAF9")
        .attr('rx', 0.5)
        .attr('ry', 0.5)
        .attr("x", 160)
        .attr("width", function(d) { return d })
        .attr("y", function(d, i) { return 48 + 17 * i })
        .attr("height", 3);


    var sub_indst_circle = board.selectAll("circle")
        .data(bar_ratio)

    var entering_c = sub_indst_circle.enter()
        .append("circle");

    sub_indst_circle.merge(entering_c)
        .transition().duration(500)
        .attr("fill", "#B3E5FC")
        .attr('r', 5)
        .attr("cx", function(d) { return 160 + d })
        .attr("cy", function(d, i) { return 50 + 17 * i })

}
//---------------------


//LOC SUB MAP ---------
function subplot_map(src, val, loc, board) {

    var proj = d3.geo.mercator();
    var path = d3.geo.path().projection(proj);

    proj.scale(2400);
    proj.translate([-420, 280]);


    var clr_data = Data.subPlot(src, val, loc + '_v_add')
    var max_val = clr_data.reduce((max, x) => x[1] > max ? x[1] : max, 0)


    clr_data.sort(function(a,b){return b[1]-a[1]})
    var txt_data=clr_data.map(x => [code_to_state[x[0]], x[1]])
    

    var colorise = d3.scaleSequential().domain([2 * max_val, -max_val / 5])
        .interpolator(d3.interpolateInferno);

    clr_data = clr_data.map(x => [code_to_state[x[0]], colorise(x[1])])
    var clr_dict = {}
    for (var i = 0; i < clr_data.length; i++)
        clr_dict[clr_data[i][0]] = clr_data[i][1]


    d3.select('#title'+board.attr('id')).remove();
    board
        .append('text')
        .attr("x", sub_indst_width/2)
        .attr("y", 10)
        .attr('id','title'+board.attr('id'))
        .attr("dy", "10px")
        .style("font-size", "15px")
        .attr('text-anchor','middle')
        .style('font-family', 'Arial')
        .attr('fill', '#607D8B')
        .text('Native state distribution');



    var sub_map = board.selectAll("path")
        .data(india_geo.features)

    var entering = sub_map.enter()
        .append("path");

    sub_map.merge(entering)
        .transition().duration(500)
        .attr("d", path)
        .style('stroke', 'white')
        .style('stroke-width', 0.5)
        .style("fill", function(d, i) {
            if (d.id in clr_dict)
                return clr_dict[d.id]
            else
                return '#CFD8DC'
        })
        .style("opacity", 0.7)


    if (clr_data.length < 5)
        clr_data = clr_data.concat(Array(5 - clr_data.length).fill(['', 'none']))
    
    d3.selectAll('.submap'+board.attr('id')).remove()
    board.selectAll('map-text')
        .data(txt_data.slice(0, 5))
        .enter()
        .append('text')
        .attr('class','submap'+board.attr('id'))
        .attr("x", 230)
        .attr("y", function(d, i) { return 130 + 17 * i })
        .attr("dy", "10px")
        .style("font-size", "13px")
        .style('font-family', 'Arial')
        .attr('fill', '#78909C')
        .text(function(d, i) { return d[0]; });

    board.selectAll('map-text')
        .data(txt_data.slice(0, 5))
        .enter()
        .append('text')
        .attr('class','submap'+board.attr('id'))
        .attr("x", 350)
        .attr('text-anchor','end')
        .attr("y", function(d, i) { return 130 + 17 * i })
        .attr("dy", "10px")
        .style("font-size", "13px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .text(function(d, i) { return d[1]});

}
//---------------------


// AGE SUB PLOT -------
function subplot_age(src, val, board) {
    

    var data = Data.subPlot(src, val, "age");
    var num_data = Array(20).fill(0)
    for (var i = 0; i < data.length; i++)
        num_data[parseInt(data[i][0]) - 1] = data[i][1]

    var sum = num_data.reduce((sum, i) => sum + i, 0)
    var max = num_data.reduce((max,i)=> max>i?max:i,0)

    if(data.length!=0)
        num_data = num_data.map(x => 180*x / max)
                       

    var scale = d3.scaleLinear()
                  .domain([0, max])
                  .range([200, 20]);

    var y_axis = d3.axisLeft()
                  .scale(scale)
                  .ticks(5)


    function customYAxis(g) {
        g.call(y_axis);
        
        g.selectAll("path")
        .attr("opacity", "0")

        g.selectAll("line")
        .attr("stroke", "#90A4AE")


        g.selectAll("text")
        .attr("fill", "#90A4AE")
    }


    var selected = d3.select('#title'+board.attr('id'));
    if (selected['_groups'][0][0] == null) { 
        board.append('g')
        .attr('class','y axis')
        .attr("transform", "translate(30, 10)")
        .call(customYAxis);

    } else { 
        board.select(".y.axis")
            .transition()
            .duration(500)
            .call(customYAxis);
    }        

    
    board.select('#title'+board.attr('id')).remove()
    board.selectAll('.subagetxt'+board.attr('id')).remove()

    board
        .append('text')
        .attr('id','title'+board.attr('id'))
        .attr("x", sub_age_width/2)
        .attr("y", 10)
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('text-anchor','middle')
        .attr('fill', '#607D8B')
        .text('Age distribution');


    board.selectAll('txt')
        .data(num_data)
        .enter().append('text')
        .attr('text-anchor', 'end')
        .attr('class','subagetxt'+board.attr('id'))
        .attr("x", function(d, i) { return 35 + 17 * i })
        .attr("y", 215)
        .attr("dy", "10px")
        .style("font-size", "10px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .text(function(d, i) { return i + 1; });

    var sub_age_bars = board.selectAll("rect")
        .data(num_data)

    var entering = sub_age_bars.enter()
        .append("rect");

    sub_age_bars.merge(entering)
        .transition().duration(500)
        .attr("fill", "#FFAB91")
        .attr('rx', 1)
        .attr('ry', 1)
        .attr('opacity', 1)
        .attr("x", function(d, i) { return 25 + 17 * i })
        .attr("width", 10)
        .attr("y", function(d) { return 210 - d })
        .attr("height", function(d) { return 1 + d });

}
//---------------------


// RAID MONTH SUB PLOT ----
function subplot_raid(month_data) {




    var month_dict = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']

    raid_sub_svg.attr("height", 200 + month_data.length * 75)
    var raid_cir = []
    for (var i = 0; i < month_data.length; i++) {
        var r = 5 + month_data[i][3]
        var y = 100 + 20 + i * 75;
        raid_cir.push([50, y, r, month_data[i][0], month_data[i][1],month_data[i][2]])
    }

    var padd = Array(40 - month_data.length).fill([50, raid_cir[month_data.length - 1][1], 0, '', '',''])
    
    raid_cir = raid_cir.concat(padd)
    //need handling for no data
    var last_c = raid_cir[month_data.length - 1][1]
    raid_cir = raid_cir.map(x => [x[0], x[1], x[2], x[3], x[4],x[5]])


    raid_dots = raid_cir.map(x => [x[0], x[1], x[2] == 0 ? 0 : 3, x[3], x[4], 1,''])
    var sub_raid_circle = raid_sub_svg.selectAll("circle")
        .data(raid_cir.concat(raid_dots))

    var entering_c = sub_raid_circle.enter()
        .append("circle");

    sub_raid_circle.merge(entering_c)
        .transition().duration(500)
        .attr("fill", "#FF7043")
        .attr('r', function(d) { return d[2] })
        .attr("cx", function(d) { return d[0] })
        .attr("cy", function(d) { return d[1] })
        .attr('opacity', function(d) { return d.length == 6 ? 0.2 : 1 })


    raid_sub_svg.selectAll("text").remove();

    var sub_raid_date = raid_sub_svg.selectAll("text")
        .data(raid_cir.concat(raid_dots))
        .enter()

    sub_raid_date
        .append("text")
        .attr("x", 150)
        .attr("y", function(d, i) { return d[1] - 5 })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#607D8B')
        .attr('opacity', 0)
        .text(function(d) {
            var m = d[3].split('/');
            if (m.length == 1) return "";
            return m[0] + ' ' + month_dict[parseInt(m[1]) - 1] + ' ' + m[2].slice(2, 4)
        })
        .transition().duration(500)
        .attr('opacity', 1)


    sub_raid_date
        .append("text")
        .attr("x", 150)
        .attr("y", function(d, i) { return d[1] + 20 })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .attr('opacity', 0)
        .text(function(d) {
            var m = d[4].split('&');
            if (m.length == 1) return "";
            return m[0] //+'\n'+m[1] 
        })
        .transition().duration(500)
        .attr('opacity', 1)

    sub_raid_date
        .append("text")
        .attr("x", 150)
        .attr("y", function(d, i) { return d[1] + 37 })
        .attr("dy", "10px")
        .style("font-size", "12px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .attr('opacity', 0)
        .text(function(d) {
            var m = d[4].split('&');
            if (m.length == 1) return "";
            return m[1].slice(0, -5) //+'\n'+m[1] 
        })
        .transition().duration(500)
        .attr('opacity', 1)

    sub_raid_date
        .append("text")
        .attr("x", 230)
        .attr("y", function(d, i) { return d[1] -6})
        .attr("dy", "10px")
        .style("font-size", "14px")
        .style('font-family', 'Arial')
        .attr('fill', '#78909C')
        .attr('opacity', 0)
        .text(function(d) { return (d[2] == 0 || d.length == 7) ? "" : '('+ind_dict[d[5]]+')'})
        .transition().duration(500)
        .attr('opacity', 1)

    sub_raid_date
        .append("text")
        .attr("x", 100)
        .attr("y", function(d, i) { return d[1] + 20 })
        .attr("dy", "10px")
        .style("font-size", "20px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .attr('opacity', 0)
        .text(function(d) { return (d[2] == 0 || d.length == 7) ? "" : d[2] })
        .transition().duration(500)
        .attr('opacity', 1)






    var sub_raid_line = raid_sub_svg.selectAll("rect")
        .data(raid_cir)

    var entering_r = sub_raid_line.enter()
        .append("rect");

    sub_raid_line.merge(entering_r)
        .transition().duration(500)
        .attr('fill', '#B0BEC5')
        .attr('stroke', 'none')
        .attr("x", function(d) { return 50 + d[2] })
        .attr("width", function(d) { return d[2] == 0 ? 0 : 95 - d[2] })
        .attr("y", function(d, i) { return d[1] })
        .attr("height", 1)
        .attr('opacity', 0.5)


}
//---------------------

// AMOUNT SUB PLOT---------
function subplot_amount(data, board,title="") {
    var max = data.reduce((max, i) => max > i[0] ? max : i[0], 0)
    var scale = 0
    if (max != 0) scale = 150 / max
    var bar_data=data.map(x=>x[0]*scale)

    var Yscale = d3.scaleLinear()
                  .domain([0, max])
                  .range([150, 0]);

    var y_axis = d3.axisLeft()
                  .scale(Yscale)
                  .ticks(5)

    var Xscale = d3.scaleLinear()
                  .domain([0, 1000+data[39][1]])
                  .range([0, 318.5]);

    var x_axis = d3.axisBottom()
                  .scale(Xscale)
                  .ticks(10)


    function customYAxis(g) {
        g.call(y_axis);
        
        g.selectAll("path")
        .attr("opacity", "0")

        g.selectAll("line")
        .attr("stroke", "#90A4AE")


        g.selectAll("text")
        .attr("fill", "#90A4AE")
    }

    function customXAxis(g) {
        g.call(x_axis);
    
        g.selectAll("path")
        .attr("opacity", "0")

        g.selectAll("line")
        .attr("stroke", "#90A4AE")


        g.selectAll("text")
        .attr("fill", "#90A4AE")
        .text(function(d){return d.toString().slice(0,-3)+'k'})


    }


    var selected = d3.select('#title'+board.attr('id'));
    if (selected['_groups'][0][0] == null) { 

        board.append('g')
        .attr('class','y axis')
        .attr("transform", "translate(30, 50)")
        .call(customYAxis);

        board.append('g')
        .attr('class','x axis')
        .attr("transform", "translate(43.5, 205)")
        .call(customXAxis);

    } else { 
        board.select(".y.axis")
            .transition()
            .duration(500)
            .call(customYAxis);
    }



    d3.selectAll('#title'+board.attr('id')).remove();

    board
        .append('text')
        .attr('id','title'+board.attr('id'))
        .attr("x", sub_age_width/2)
        .attr("y", 10)
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('text-anchor','middle')
        .attr('fill', '#607D8B')
        .text(title+' distribution');


    var amt_bar = board.selectAll('rect')
        .data(bar_data)


    var entering = amt_bar.enter()
        .append("rect");

    amt_bar.merge(entering)
        .transition().duration(500)
        .attr("fill", '#81C784')
        .attr("x", function(d, i) { return 40 + i * 8 })
        .attr("width", 7)
        .attr('rx', 0.5)
        .attr('ry', 0.5)
        .attr("y", function(d) { return 200 - d})
        .attr("height", function(d) { return d})
        .attr('opacity', 0.5)

}



//INDST SUB PLOT---------
function subplot_indst_loc(indst) {
    var loc = Data.industryLoc(indst)
    var native_loc = []
    var raid_loc = []


    for (var i = 0; i < loc['native'].length; i++) {
        var v = loc['native'][i][0].split(',')
        if (v.indexOf("") != -1) continue
        if (v.indexOf(" ") != -1) continue

        native_loc.push(loc['native'][i])
    }
    for (var i = 0; i < loc['raid'].length; i++) {
        var v = loc['raid'][i][0].split(',')
        if (v.indexOf("") != -1) continue
        if (v.indexOf(" ") != -1) continue

        raid_loc.push(loc['raid'][i])
    }

    native_loc = native_loc.slice(0, 10)
    raid_loc = raid_loc.slice(0, 10)


    indst_sub_svg.selectAll("text").remove();
    var native_text = indst_sub_svg.selectAll("native")
        .data(native_loc)
        .enter()

    native_text
        .append("text")
        .attr("x", 25)
        .attr("y", function(d, i) { return 30 + i * 20 })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .attr('opacity', 0)
        .text(function(d) { return d[0].slice(0, -7) })
        .transition().duration(500)
        .attr('opacity', 1)

    var raid_text = indst_sub_svg.selectAll("native")
        .data(raid_loc)
        .enter()

    raid_text
        .append("text")
        .attr("x", 25)
        .attr("y", function(d, i) { return 270 + i * 20 })
        .attr("dy", "10px")
        .style("font-size", "15px")
        .style('font-family', 'Arial')
        .attr('fill', '#B0BEC5')
        .attr('opacity', 0)
        .text(function(d) { return d[0].slice(0, -7) })
        .transition().duration(500)
        .attr('opacity', 1)


    subplot_amount(loc['wage'], indst_wage_svg)


}
//----------------------



// ------------------------------------------------


//DICTS

ind_dict = {
        "Abattoirs/Slaughter Houses": "Slaughter Houses",
        "Agriculture": "Agriculture",
        "Automobile/Transport": "Automobile",
        "Bakery": "Bakery",
        "Brick Kilns & Roof tiles units": "Brick & tiles kilns",
        "Building and Construction": "Construction",
        "Carpentry": "Carpentry",
        "Carpet Industry": "Carpet Industry",
        "Cosmetic": "Cosmetic",
        "Cracker Industry": "Cracker Industry",
        "Curtain Making Unit": "Curtain Making",
        "Dairy Products": "Dairy Products",
        "Domestic Servant": "Domestic Servant",
        "Electrical & Electronics": "Electronics",
        "Factory": "Factory",
        "Flour Mill": "Flour Mill",
        "Footwear": "Footwear",
        "Garment": "Garment",
        "Handicraft": "Handicraft",
        "Hotel/Dhaba": "Hotel",
        "Jewellery": "Jewellery",
        "Jute/Plastic/Rexin/Cloth Bags": "Cloth Bags",
        "Leather": "Leather",
        "Lock Making": "Lock Making",
        "Metal": "Metal",
        "Odd Jobs": "Odd Jobs",
        "Paint Making Unit": "Paint Making",
        "Paper Industry": "Paper Industry",
        "Plastic and Nylon units": "Plastic units",
        "Printing": "Printing",
        "Retail Shop/Office": "Retail Shop",
        "Sculpture Making Unit": "Sculpture Making",
        "Stone Quarry": "Stone Quarry",
        "Suitcase Making": "Suitcase Making",
        "Tobacco & Chewing Tobacco": "Tobacco",
        "Toy Making Unit": "Toy Making Unit",
        "Umbrela Making Factory": "Umbrela Factory",
        "Others": "Others"
    }

//---------------

// MAP INITS --------------------------------------


var map;
var map_controls_svg = d3.select("#map-controls")
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", map_controls_width+50)
    .attr("height", map_controls_height)
    .style('background-color','white')

var is_hm = 'y'
var map_age = 0
var map_time = [3, 8]
var map_ind = Array(15).fill(0).map((x, i) => i)
var map_loc = 'native'

mapHeatmap(map_loc, Data.filterPoints(map_age, map_time, map_ind, map_loc))
map_controls()


// STATE INIT --------------------

var state_svg
var curr_st='Maharashtra'
var sel_state='from'


var state_age_svg= d3.select("#state-age-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr('id','state_age_svg')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)
    .style('background-color','#FBE9E7')
    

var state_indst_svg = d3.select("#state-indst-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr('id','state_indst_svg')
    .attr("width", sub_indst_width)
    .attr("height", sub_indst_height)
    .style('background-color','#E3F2FD')

var state_paramt_svg = d3.select('#state-paramt-sub')
    .append("svg")
    .attr('display', 'inline-block')
    .attr('id','state_paramt_svg')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)
    .style('background-color','#F9FBE7')

map_state();


//-------------------------------------------------

// PLOT INITS -------------------------------------


//AGE PLOT INIT ------
var age_svg
var curr_age

var age_indst_svg = d3.select("#age-indst-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr('id','age_indst_svg')
    .attr("width", sub_indst_width)
    .attr("height", sub_indst_height)
    .style('background-color','#E3F2FD')
    

var age_map_svg = d3.select("#age-map-sub").append("svg:svg")
    .attr("width", sub_map_width)
    .attr("height", sub_map_height)
    .style('background-color','#FFF3E0')
    .append("svg:g")
    .attr('id','age_map_svg')


age_plot();
subplot_indst("age", 13, age_indst_svg);
subplot_map("age", 13, "native", age_map_svg);
//--------------------




//TRAF PLOT INIT -----
var traf_svg
var curr_traf

var traf_age_svg = d3.select("#traf-age-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)
    .style('background-color','#FBE9E7')
    .attr('id','traf_age_svg')

var traf_indst_svg = d3.select("#traf-indst-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_indst_width)
    .attr("height", sub_indst_height)
    .attr('id','traf_indst_svg')
    .style('background-color','#E3F2FD')

var traf_map_svg = d3.select("#traf-map-sub").append("svg:svg")
    .attr("width", sub_map_width)
    .attr("height", sub_map_height)
    .style('background-color','#FFF3E0')
    .append("svg:g")
    .attr('id','traf_map_svg')



traf_plot()
subplot_age('t_date', 40, traf_age_svg)
subplot_indst("t_date", 40, traf_indst_svg);
subplot_map("t_date", 40, "native", traf_map_svg);
//--------------------

//RAID PLOT INIT -----

var raid_svg_g
var curr_raid_month
var curr_raid_raid

var raid_sub_svg = d3.select('#sub-raid')
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_raid_width)
    .attr("height", sub_raid_height)

raid_plot()
//--------------------

//AMOUNT PLOT INIT --

var amount1_sub_svg = d3.select('#sub-amount-1')
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)

var amount2_sub_svg = d3.select('#sub-amount-2')
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)

amount_plot()


//--------------------

//SCHOOL PLOT INIT --

var school_svg
school_plot()
//

//INDST PLOT INIT ---

var indst_svg;
var indst_sub_svg = d3.select("#indst-sub")
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height * 2)

var indst_wage_svg = d3.select('#indst-sub')
    .append("svg")
    .attr('display', 'inline-block')
    .attr("width", sub_age_width)
    .attr("height", sub_age_height)


indust_plot()
subplot_indst_loc('Garment')

// -------------


//------------------------------------------------

d3.selectAll('.nav-btn').on('click', function() {
    var _id = '#' + d3.select(this).attr('id').split('-')[1]
    d3.selectAll('.page-sec').style('display', 'none')
    d3.select(_id + '-sec').style('display', 'block')

    d3.selectAll('.nav-btn').classed('nav-btn-sel', false)
    d3.select(this).classed('nav-btn-sel', true)
})
d3.select('#traf-sec').style('display', 'block')
d3.select('#nav-traf').classed('nav-btn-sel', true)
</script>

<script type="text/javascript">
map.on('load', function() {

    var adminLayers = ['admin-0-boundary', 'admin-0-boundary-disputed'];
    adminLayers.forEach(function(adminLayer) {
        map.setFilter(adminLayer, ["match", ["get", "worldview"],
            ["all", "IN"], true, false
        ]);
    });
});
</script>

</html>